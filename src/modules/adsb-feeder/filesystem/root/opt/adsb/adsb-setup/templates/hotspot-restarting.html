{% extends "base-container.html" %}
{% set active_page = "hotspot" %}
{% block title %}
  Trying to connect to WiFi
{% endblock title %}
{% block content %}
  <!-- Explanatory Text -->
  <div class="alert alert-info mb-4" role="alert">
    <h5 class="alert-heading">Device Restart in Progress</h5>
    <p class="mb-0">
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
      The device is restarting and attempting to connect to the configured network. This process may take a few minutes.
    </p>
  </div>
  <!-- Progress Steps -->
  <div class="card">
    <ul class="list-group list-group-light list-group-flush px-4">
      <li class="list-group-item d-flex justify-content-between align-items-center"
          id="step-1">
        <div>
          <span class="step-icon far fa-circle text-muted me-3"></span>
          <span id="step-1-text">Step 1</span>
        </div>
        <span class="step-badge badge badge-secondary rounded-pill">Pending</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center text-muted"
          id="step-2">
        <div>
          <span class="step-icon far fa-circle text-muted me-3"></span>
          <span id="step-2-text">Step 2</span>
        </div>
        <span class="step-badge badge badge-secondary rounded-pill">Pending</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center text-muted"
          id="step-3">
        <div>
          <span class="step-icon far fa-circle text-muted me-3"></span>
          <span id="step-3-text">Step 3</span>
        </div>
        <span class="step-badge badge badge-secondary rounded-pill">Pending</span>
      </li>
    </ul>
  </div>
  <!-- Status Message -->
  <div class="alert alert-warning mt-4 d-none"
       role="alert"
       id="timeout-message">
    <span class="fas fa-exclamation-triangle me-2"></span>
    Device has probably joined the configured network!
  </div>
  <script>
    let currentStep = 0;

    function updateStepStatus(stepNumber, status) {
      if (!["done","error","in-progress"].includes(status)) {
        console.error(`Invalid step status: ${status}`);
        return;
      }
      const stepElement = $(`#step-${stepNumber}`);
      const iconElement = stepElement.find(".step-icon");
      const badgeElement = stepElement.find(".step-badge");

      // Remove text-muted class to make it visible
      stepElement.removeClass("text-muted");
      iconElement.removeClass(
        "far fas fa-circle fa-circle-check fa-circle-notch fa-circle-xmark fa-spin text-muted text-success text-danger "
          + "text-primary");
      badgeElement.removeClass("badge-secondary badge-success badge-danger badge-primary");

      if (status === "done") {
        // Green checkmark for completed steps
        iconElement.addClass("far fa-circle-check text-success");
        badgeElement.addClass("badge-success");
        badgeElement.text("Done");
      } else if (status === "error") {
        // Red X for failed steps
        iconElement.addClass("far fa-circle-xmark text-danger");
        badgeElement.addClass("badge-danger");
        badgeElement.text("Failed");
      } else if (status === "in-progress") {
        // Spinning icon for current step
        iconElement.addClass("fas fa-circle-notch fa-spin text-primary");
        badgeElement.addClass("badge-primary");
        badgeElement.text("In Progress");
      }
    }

    function simulateProgress() {
      // This is a placeholder - you can replace this with actual progress tracking
      // based on the response from checkRestartStatus()
      if (currentStep < 3) {
        if (currentStep > 0) {
          updateStepStatus(currentStep, "done");
        }
        currentStep++;
        updateStepStatus(currentStep, "in-progress");
      }
    }

    function after60() {
      // Show timeout message after 60 seconds
      document.getElementById("timeout-message").classList.remove("d-none");
    }

    function checkRestartStatus() {
      $.ajax({
        url: "/api/statusz",
        type: "GET",
        timeout: 2000, // Timeout after 2 seconds
        success: function (data) {
          const restartState = data.hotspot_status.restart_state;
          if (restartState === "done") {
            // Mark all steps as done and redirect
            for (let i = 1; i <= 3; i++) {
              updateStepStatus(i, "done");
            }
            //setTimeout(function () {
            //  window.location.replace("/");
            //}, 1000);
          } else if (restartState === "restarting") {
            // Simulate progress (you can enhance this based on actual status data)
            simulateProgress();
            setTimeout(checkRestartStatus, 2000);
          }
        },
        error: function (jqXHR, textStatus, errorThrown) {
          if (textStatus === "timeout") {
            console.log("Request to GET /api/statusz timed out.");
          } else {
            console.log("Request to GET /api/statusz resulted in an error: ", textStatus, errorThrown);
          }
          if (currentStep > 0) {
            updateStepStatus(currentStep, "error");
          }
          setTimeout(checkRestartStatus, 2000);
        },
      });
    }

    // Start with step 1
    currentStep = 1;
    updateStepStatus(1, "in-progress");

    checkRestartStatus();
    setTimeout(after60, 60 * 1000);
  </script>
{% endblock content %}
