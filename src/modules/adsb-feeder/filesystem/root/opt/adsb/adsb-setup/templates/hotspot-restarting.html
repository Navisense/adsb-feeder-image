{% extends "base-container.html" %}
{% set active_page = "hotspot" %}
{% block title %}
  Trying to connect to WiFi
{% endblock title %}
{% block content %}
  <!-- Explanatory Text -->
  <div class="alert alert-info mb-4" role="alert">
    <h5 class="alert-heading">Porttracker SDR Connecting to WiFi</h5>
    <p class="mb-0">Your Porttracker SDR device is trying to connect to the WiFi network you provided.</p>
  </div>
  <!-- Progress Steps -->
  <div class="card">
    <ul class="list-group list-group-light list-group-flush px-4">
      <!-- Step 1: Stop the hotspot -->
      <li class="list-group-item py-3 text-muted" id="step-1">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-flex align-items-start flex-grow-1">
            <span class="step-icon far fa-circle me-3 mt-1"></span>
            <div class="flex-grow-1">
              <div class="fw-bold mb-1">Stop the hotspot</div>
              <!-- Pending state description -->
              <div class="step-description step-description-pending small d-none">
                The device has received the network SSID and password you provided. First, it needs to stop the hotspot
                we were just connected to. This is necessary so it can try to connect to the network.
              </div>
              <!-- In-progress state description -->
              <div class="step-description step-description-in-progress small">
                We're waiting for the device to stop the hotspot. When we can't reach it anymore, we'll know that it has
                stopped.
              </div>
              <!-- Done state description -->
              <div class="step-description step-description-done small d-none">
                We can no longer reach the device in its hotspot mode. This means it has stopped successfully.
              </div>
              <!-- Error state description -->
              <div class="step-description step-description-error small d-none">
                We've encountered an unknown state while checking the hotspot.
                <div class="step-description-error-detail small"></div>
              </div>
            </div>
          </div>
          <span class="step-badge badge badge-secondary rounded-pill ms-3">Pending</span>
        </div>
      </li>
      <!-- Step 2: Connect to the network -->
      <li class="list-group-item py-3 text-muted" id="step-2">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-flex align-items-start flex-grow-1">
            <span class="step-icon far fa-circle me-3 mt-1"></span>
            <div class="flex-grow-1">
              <div class="fw-bold mb-1">Connect to the network</div>
              <!-- Pending state description -->
              <div class="step-description step-description-pending small">
                When we can't reach the hotspot anymore, we will wait for the device to connect to the new network.
              </div>
              <!-- In-progress state description -->
              <div class="step-description step-description-in-progress small d-none">
                We're waiting for the device to connect to the new network. We're doing this by continuously trying to
                reach the device. This will only work if the computer or phone you're viewing this on will also connect
                to the same network. If this takes longer than half a minute, check in your own system settings that you
                are connected to the same WiFi that we're trying to get the Porttracker SDR to connect to.
              </div>
              <!-- Done state description -->
              <div class="step-description step-description-done small d-none">
                Success! We've heard back from the device.
              </div>
              <!-- Error state description -->
              <div class="step-description step-description-error small d-none">
                We've been waiting for the device to connect to the new network for a while, but it hasn't happened yet.
                This could be for a number of reasons:
                <ul>
                  <li>
                    Network out of range. If the device is too far away from the router, it may not get a reliable
                    signal.
                  </li>
                  <li>
                    Maybe you provided the wrong password. In that case, the device will restart the hotspot so you
                    can try again. Check if there is a WiFi named {{ get_conf("feeder_name") }} and connect to it.
                  </li>
                  <li>
                    mDNS is not enabled on you computer/phone. The device uses mDNS (also known as Bonjour, Avahi, or
                    Zeroconf) to tell us how we can reach it. Your computer/phone needs to support this. There was a
                    test on the previous page, if that showed a negative result, it's expected that this step will fail.
                    You will need to enable mDNS, or check in the settings of your router/access point whether the
                    device has connected.
                  </li>
                </ul>
                <div class="step-description-error-detail small"></div>
              </div>
            </div>
          </div>
          <span class="step-badge badge badge-secondary rounded-pill ms-3">Pending</span>
        </div>
      </li>
      <!-- Step 3: Connection established -->
      <li class="list-group-item py-3 text-muted" id="step-3">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-flex align-items-start flex-grow-1">
            <span class="step-icon far fa-circle me-3 mt-1"></span>
            <div class="flex-grow-1">
              <div class="fw-bold mb-1">Connection established</div>
              <!-- Pending state description -->
              <div class="step-description step-description-pending small">
                After connecting, we'll verify the connection is stable and complete the setup.
              </div>
              <!-- In-progress state description -->
              <div class="step-description step-description-in-progress small d-none">
                We've heard back from the device, and are checking that everything is working as expected.
              </div>
              <!-- Done state description -->
              <div class="step-description step-description-done small d-none">
                You're good to go! The device has assumed normal operation. You can visit the home page at
                <a href="http://{{ get_conf("feeder_name") }}.local">http://{{ get_conf("feeder_name") }}.local</a>.
              </div>
              <!-- Error state description -->
              <div class="step-description step-description-error small d-none">
                We were able to reach the device, but it hasn't assumed normal operation as we expected.
                <div class="step-description-error-detail small"></div>
              </div>
            </div>
          </div>
          <span class="step-badge badge badge-secondary rounded-pill ms-3">Pending</span>
        </div>
      </li>
    </ul>
  </div>
  <!-- Status Message -->
  <div class="alert alert-warning mt-4 d-none"
       role="alert"
       id="timeout-message">
    <span class="fas fa-exclamation-triangle me-2"></span>
    Device has probably joined the configured network!
  </div>
  <script>
    let currentStep = 1;
    let keepChecking = true;
    const startTime = Date.now();

    function updateStepStatus(stepNumber, status) {
      if (!["done", "error", "in-progress"].includes(status)) {
        console.error(`Invalid step status: ${status}`);
        return;
      }
      const stepElement = $(`#step-${stepNumber}`);
      const iconElement = stepElement.find(".step-icon");
      const badgeElement = stepElement.find(".step-badge");
      stepElement.removeClass("text-muted");

      // Hide all description variants and show the one for the current status
      stepElement.find(".step-description").addClass("d-none");
      stepElement.find(`.step-description-${status}`).removeClass("d-none");

      iconElement.removeClass(
        "far fas fa-circle fa-circle-check fa-circle-notch fa-circle-xmark fa-spin text-success text-danger "
        + "text-primary");
      badgeElement.removeClass("badge-secondary badge-success badge-danger badge-primary");

      if (status === "done") {
        // Green checkmark for completed steps
        iconElement.addClass("far fa-circle-check text-success");
        badgeElement.addClass("badge-success");
        badgeElement.text("Done");
      } else if (status === "error") {
        // Red X for failed steps
        iconElement.addClass("far fa-circle-xmark text-danger");
        badgeElement.addClass("badge-danger");
        badgeElement.text("Failed");
      } else if (status === "in-progress") {
        // Spinning icon for current step
        iconElement.addClass("fas fa-circle-notch fa-spin text-primary");
        badgeElement.addClass("badge-primary");
        badgeElement.text("In Progress");
      }
    }

    function checkRestartStatus() {
      $.ajax({
        url: "http://{{ get_conf("feeder_name") }}.local/api/statusz",
        type: "GET",
        timeout: 200,
        success: function (feederStatus) {
          updateStatus(feederStatus, undefined);
        },
        error: function (jqXHR, textStatus, errorThrown) {
          updateStatus(undefined, textStatus);
        },
      });
      if (Date.now() - startTime > 60 * 1000) {
        $("#timeout-message").removeClass("d-none");
      } else if (keepChecking) {
        // Only check again if we're not done.
        setTimeout(checkRestartStatus, 200);
      }
    }

    function updateStatus(feederStatus, errorStatus) {
      while (true) {
        switch (currentStep) {
          case 1:
            // Step 1: Stop the hotspot.
            // We need to see that the device is disconnected (timeout) or no longer in hotspot mode.
            if (errorStatus === "timeout" || errorStatus === "error") {
              console.log("Step 1: Can't reach the device, hotspot must have stopped. Progressing to step 2.");
              updateStepStatus(currentStep, "done");
              currentStep++;
              updateStepStatus(currentStep, "in-progress");
              // Continue to check step 2
            } else if (feederStatus?.mode === "hotspot") {
              console.log("Step 1: Device is still in hotspot mode. Waiting...");
              return;
            } else if (feederStatus?.mode === "regular") {
              // Hotspot stopped and device is already connected.
              console.log("Step 1: Device is no longer in hotspot mode. Progressing to step 2.");
              updateStepStatus(currentStep, "done");
              currentStep++;
              updateStepStatus(currentStep, "in-progress");
              // Continue to check step 2.
            } else {
              updateStepStatus(currentStep, "error");
              const errorDetail = (
                `When requesting a status from the device, we got error `
                + `${errorStatus}, and status ${JSON.stringify(feederStatus)}`);
              $("#step-1 .step-description-error-detail").text(errorDetail);
              console.log(`Step 1: Unknown state while checking status. ${errorDetail}`);
              // Unknown state, keep waiting
              return;
            }
            break;
          case 2:
            // Step 2: Connect to the network.
            // We're trying to reach the device on the network.
            if (errorStatus === "timeout" || errorStatus === "error") {
              console.log("Step 2: Still can't reach the device. Waiting for connection...");
              return;
            } else if (feederStatus?.mode === "regular") {
              // We can reach the device and it's in regular mode - connection successful!
              console.log("Step 2: Device is reachable in regular mode. Connection successful!");
              updateStepStatus(currentStep, "done");
              currentStep++;
              updateStepStatus(currentStep, "in-progress");
              // Continue to check step 3.
            } else if (feederStatus?.mode === "hotspot") {
              // Device went back to hotspot mode - connection failed.
              updateStepStatus(currentStep, "error");
              const errorDetail = (
                `When requesting a status from the device, we got error `
                + `${errorStatus}, and status ${JSON.stringify(feederStatus)}`);
              $("#step-2 .step-description-error-detail").text(errorDetail);
              console.log(`Step 2: Device is back in hotspot mode. Connection failed. ${errorDetail}`);
              return;
            } else {
              updateStepStatus(currentStep, "error");
              const errorDetail = (
                `When requesting a status from the device, we got error `
                + `${errorStatus}, and status ${JSON.stringify(feederStatus)}`);
              $("#step-2 .step-description-error-detail").text(errorDetail);
              console.log(`Step 2: Unknown state while checking status. ${errorDetail}`);
              // Unknown state, keep waiting.
              return;
            }
            break;
          case 3:
            // Step 3: Connection established.
            // Verify the restart process is complete.
            if (feederStatus?.mode === "regular" && feederStatus?.hotspot_status?.restart_state === "done") {
              console.log("Step 3: Connection fully established. Restart complete!");
              updateStepStatus(currentStep, "done");
              keepChecking = false;
              return;
            } else if (feederStatus?.mode === "regular") {
              // Already in regular mode, but the device doesn't report a successful wifi connection..
              console.log(
                "Step 3: Device appears to be connected, but doesn't report a successful wifi connection. Waiting...");
              return;
            } else {
              updateStepStatus(currentStep, "error");
              const errorDetail = (
                `When requesting a status from the device, we got error `
                + `${errorStatus}, and status ${JSON.stringify(feederStatus)}`);
              $("#step-3 .step-description-error-detail").text(errorDetail);
              console.log(`Step 3: Unknown state while checking status. ${errorDetail}`);
              return;
            }
          default:
            console.log(`Invalid step number ${currentStep}`);
            return;
        }
      }
    }

    // Start with step 1, then keep checking and updating.
    updateStepStatus(1, "in-progress");
    checkRestartStatus();
  </script>
{% endblock content %}
