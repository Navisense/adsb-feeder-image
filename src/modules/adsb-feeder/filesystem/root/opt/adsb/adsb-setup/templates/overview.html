{% extends "base-regular.html" %}
{% set active_page = "overview" %}
{% block title %}
  Porttracker SDR Feeder
{% endblock title %}
{% block content %}
  <div class="alert alert-danger {% if not compose_up_failed %}d-none{% endif %}"
       role="alert">
    docker compose up has failed. This means that something is wrong.
    <form method="post">
      <button type="submit" class="btn btn-primary">Retry</button>
    </form>
  </div>
  <div class="alert alert-danger {% if not system.undervoltage %}d-none{% endif %}"
       role="alert">
    The feeder system kernel detected under-voltage. This can lead to random crashes and various issues with clock
    stability, reduced reception, failing SDRs, etc. Please check and likely replace your power supply.
  </div>
  <div id="low-disk"
       class="alert alert-info {% if not system.system_info.has_low_disk %}d-none{% endif %}"
       role="alert">
    You are running low on disk space on the your feeder. This can lead to odd problems and even crashes. Consider
    upgrading to a larger storage device.
  </div>
  {% if not aggregators_chosen %}
    <div class="alert alert-info">
      You have not yet chosen which aggregators to share data with. You can do this on the
      <a href="{{ url_for('aggregators') }}">data sharing page</a>.
    </div>
  {% endif %}
  {% if get_conf('managed_user') %}
    <div class="alert alert-warning">
      This device is running a ready-made image with a default password for the user
      <strong>{{ get_conf("managed_user") }}</strong>. You should set your own password on the
      <a href="{{ url_for('network-security-setup') }}">network and security setup page</a>.
    </div>
  {% endif %}
  <div class="card my-2">
    <div class="card-body">
      <div class="position-absolute top-0 end-0 m-3 d-flex align-items-center">
        <span class="text-muted me-2 d-none d-sm-inline">
          Last update: <span id="last-update-network-info-counter">never</span>
        </span>
        <button id="last-update-network-info-button"
                type="button"
                class="btn btn-secondary btn-floating"
                onclick="updateNetworkInfo()">
          <span class="fas fa-arrows-rotate"></span>
        </button>
      </div>
      <h5 class="card-title">Network info</h5>
      <div id="network-info"></div>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <div class="position-absolute top-0 end-0 m-3 d-flex align-items-center">
        <span class="text-muted me-2 d-none d-sm-inline">
          Last update: <span id="last-update-sdr-devices-counter">never</span>
        </span>
        <button id="last-update-sdr-devices-button"
                type="button"
                class="btn btn-secondary btn-floating"
                onclick="updateSdrDevices()">
          <span class="fas fa-arrows-rotate"></span>
        </button>
      </div>
      <h5 class="card-title">Available SDR devices</h5>
      These SDR devices are connected. You can configure SDR devices on the
      <a href="{{ url_for('sdr_setup') }}">SDR setup page</a>.
      <div id="sdr-devices" class="row my-3"></div>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <div class="position-absolute top-0 end-0 m-3 d-flex align-items-center">
        <span class="text-muted me-2 d-none d-sm-inline">
          Last update: <span id="last-update-reception-counter">never</span>
        </span>
        <button id="last-update-reception-button"
                type="button"
                class="btn btn-secondary btn-floating"
                onclick="updateReceptionStats()">
          <span class="fas fa-arrows-rotate"></span>
        </button>
      </div>
      <h5 class="card-title">Data reception</h5>
      <div class="row mt-4">
        <div class="col-12 col-lg-6">
          <div id="ais-stats" class="alert">AIS: No information (checking...)</div>
        </div>
        <div class="col-12 col-lg-6">
          <div id="adsb-stats" class="alert">ADS-B: No information (checking...)</div>
        </div>
      </div>
    </div>
    <div id="chart-wrapper" class="m-2 m-lg-5 d-none d-sm-block">
      <canvas id="reception-history-chart"></canvas>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <div class="position-absolute top-0 end-0 m-3 d-flex align-items-center">
        <span class="text-muted me-2 d-none d-sm-inline">
          Last update: <span id="last-update-aggregators-counter">never</span>
        </span>
        <button id="last-update-aggregators-button"
                type="button"
                class="btn btn-secondary btn-floating"
                onclick="updateAggregatorInfos()">
          <span class="fas fa-arrows-rotate"></span>
        </button>
      </div>
      <h5 class="card-title">Data sharing</h5>
      You are sharing data with these aggregators. You can add or remove aggregators on the
      <a href="{{ url_for('aggregators') }}">data sharing setup page</a>.
      <div id="aggregators" class="row my-3"></div>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <div class="position-absolute top-0 end-0 m-3 d-flex align-items-center">
        <span class="text-muted me-2 d-none d-sm-inline">
          Last update: <span id="last-update-version-counter">never</span>
        </span>
        <button id="last-update-version-button"
                type="button"
                class="btn btn-secondary btn-floating"
                onclick="updateVersionInfo()">
          <span class="fas fa-arrows-rotate"></span>
        </button>
      </div>
      <h5 class="card-title">Version</h5>
      <div id="version-info"></div>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <div class="position-absolute top-0 end-0 m-3 d-flex align-items-center">
        <span class="text-muted me-2 d-none d-sm-inline">
          Last update: <span id="last-update-device-discovery-counter">never</span>
        </span>
        <button id="last-update-device-discovery-button"
                type="button"
                class="btn btn-secondary btn-floating"
                onclick="updateOtherFeeders()">
          <span class="fas fa-arrows-rotate"></span>
        </button>
      </div>
      <h5 class="card-title">Other devices</h5>
      <div id="device-discovery" class="row my-3"></div>
      <p class="text-muted">Note that only devices that have mDNS enabled can be discovered here.</p>
    </div>
  </div>
  <script src="{{ url_for('static', filename='js/chart.js') }}"
          integrity="sha256-QvTb/nDEMP/CLHEo82yujVmcrJC4zTfI9CpZ5WXl3rc="
          crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/moment.min.js') }}"
          integrity="sha256-Wz7vWK+PBRpzNQ+1MMzRgm5qIeqECmDVqbgay204I6A="
          crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/chartjs-adapter-moment.js') }}"
          integrity="sha256-p6tY88yPX1/I2nC4PfLYbXO21Y6CV+3eOsWtOdkHt3Y="
          crossorigin="anonymous"></script>
  <script type="text/javascript"
          src="{{ url_for('static', filename='js/netstatus.js') }}"></script>
  <script type="text/javascript"
          src="{{ url_for('static', filename='js/update-time-counter.js') }}"></script>
  <script>
    function createReceptionHistoryChart() {
      let context = document.getElementById("reception-history-chart");
      let chart = new Chart(context, {
        type: 'line',
        data: {
          labels: [],
          datasets: []
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onResize: function(chart, size) {
            const enoughHeight = size.height >= 250;
            const enoughWidth = size.width >= 768;
            chart.options.plugins.legend.display = enoughHeight;
            chart.options.scales.x.ticks.display = enoughHeight;
            chart.options.scales.x.grid.drawOnChartArea = enoughHeight;
            chart.options.scales.pps.ticks.display = enoughWidth;
            chart.options.scales.pps.title.display = enoughWidth;
            chart.options.scales.num.ticks.display = enoughWidth;
            chart.options.scales.num.title.display = enoughWidth;
          },
          plugins: {
            title: {
              display: true,
              text: "Reception statistics",
              font: {
                size: 18,
              }
            },
            legend: {
              onClick: function (e, legendItem) {
                let index = legendItem.datasetIndex;
                if (this.chart.shownIndices.has(index)) {
                  this.chart.shownIndices.delete(index);
                } else {
                  this.chart.shownIndices.add(index);
                }
                if (this.chart.shownIndices.size == this.chart.data.datasets.length) {
                  this.chart.shownIndices.clear();
                }
                updateChartWithShownIndices(this.chart);
              },
              labels: {
                boxWidth: 20,
                useBorderRadius: true,
                borderRadius: 2
              }
            }
          },
          scales: {
            x: {
              type: "time",
              time: {
                tooltipFormat: "YYYY-MM-DD HH:mm:ss",
                minUnit: "second",
                displayFormats: {
                  second: "HH:mm:ss",
                  minute: "HH:mm:ss",
                  hour: "YYYY-MM-DD HH:mm:ss",
                  day: "YYYY-MM-DD",
                  week: "YYYY-MM-DD",
                  month: "YYYY-MM-DD",
                  quarter: "YYYY-MM-DD",
                  year: "YYYY",
                },
              }
            },
            pps: {
              title: {text: "pos/s", display: true},
              type: "linear",
              display: "auto",
              position: "left",
              beginAtZero: true,
            },
            num: {
              title: {text: "number of ships/planes", display: true},
              type: "linear",
              display: "auto",
              position: "right",
              beginAtZero: true,
              grid: {
                drawOnChartArea: false, // Only show grid lines for one axis.
              },
            },
          }
        }
      });
      chart.shownIndices = new Set();
      return chart;
    }

    function updateChartWithShownIndices(chart) {
      // Extend the x axis to the current time.
      chart.options.scales.x.suggestedMax = moment();
      const showAll = chart.shownIndices.size == 0;
      for (let i = 0; i < chart.data.datasets.length; i++) {
        let meta = chart.getDatasetMeta(i);
        meta.hidden = !(showAll || chart.shownIndices.has(i));
      }
      chart.update("none");
    }

    let receptionHistoryChart = createReceptionHistoryChart();


    let connectivityChecker = undefined;
    // Store the last known reachability state to avoid flickering on reload.
    let lastReachabilityState = {
      hasReachableHost: false,
      stillChecking: true,
      lastChecked: 0
    };
    // Store the last network info to allow updating the summary from reachability checks.
    let lastNetworkInfo = null;
    // Track whether the network details are expanded (persists during AJAX reloads).
    let networkDetailsExpanded = false;

    function updateNetworkStatusSummary() {
      if (!lastNetworkInfo) return;

      const isLocalAccess = ["localhost", "127.0.0.1", "::1"].includes(window.location.hostname);
      const container = $("#network-info");

      // Determine network status.
      const hasMajorAlerts = (
        !lastNetworkInfo.has_internet ||
        lastNetworkInfo.ipv6_broken ||
        !lastNetworkInfo.dns_is_working
      );

      // For local access, assume reachable. For remote, use stored state.
      let hasReachableHost = isLocalAccess;
      let isChecking = false;

      if (!isLocalAccess) {
        if (lastReachabilityState.lastChecked > 0) {
          // Use the last known state if we have one.
          hasReachableHost = lastReachabilityState.hasReachableHost;
          isChecking = lastReachabilityState.stillChecking;
        } else if (lastNetworkInfo.device_hosts?.length > 0) {
          // We have hosts but haven't checked them yet.
          isChecking = true;
        }
      }

      const networkIsOk = hasReachableHost && !hasMajorAlerts;
      const networkHasIssues = hasReachableHost && hasMajorAlerts;

      // Create summary status.
      let statusClass = '';
      let statusText = '';

      if (networkIsOk) {
        statusClass = 'alert-success';
        statusText = 'Network is OK';
      } else if (isChecking) {
        statusClass = 'alert-info';
        statusText = 'Checking network status...';
      } else if (networkHasIssues) {
        statusClass = 'alert-warning';
        statusText = 'Network has some issues';
      } else {
        statusClass = 'alert-danger';
        statusText = 'Network is not OK';
      }

      // Update or create the status alert.
      let statusAlert = container.find('.network-status-summary');
      if (statusAlert.length) {
        // Update existing alert.
        statusAlert.removeClass('alert-info alert-success alert-warning alert-danger').addClass(statusClass);
        statusAlert.find('.network-status-text').text(statusText);
      } else {
        // Create new alert (first time).
        container.append(
          `<div class="alert ${statusClass} my-3 network-status-summary">
            <strong class="network-status-text">${statusText}</strong>
            <button id="network-details-toggle" class="btn btn-sm btn-link float-end" type="button" data-mdb-toggle="collapse" data-mdb-target="#network-details" aria-expanded="false" aria-controls="network-details">
              <span class="network-details-toggle-text">Show details</span>
              <i class="fas fa-chevron-down network-details-icon"></i>
            </button>
          </div>`);
        // Add toggle behavior (only needed once).
        $('#network-details-toggle').on('click', function() {
          networkDetailsExpanded = !networkDetailsExpanded;
          if (networkDetailsExpanded) {
            setNetworkDetailToggleButton(true);
          } else {
            setNetworkDetailToggleButton(false);
          }
        });
      }
    }

    function setNetworkDetailToggleButton(show) {
      const icon = $('.network-details-icon');
      const text = $('.network-details-toggle-text');
      if (show) {
        icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        text.text('Hide details');
      } else {
        icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        text.text('Show details');
      }
    }

    async function updateNetworkInfo() {
      $.ajax("/api/network-info").done(function (networkInfo) {
        // Store for use by updateNetworkStatusSummary().
        lastNetworkInfo = networkInfo;
        // In local mode, we don't do connectivity checking, and the format is slightly different.
        const isLocalAccess = ["localhost", "127.0.0.1", "::1"].includes(window.location.hostname);
        const container = $("#network-info");
        container.html(
          `<p>
            This is <strong>${networkInfo.feeder_name}</strong>. You can configure network access on the
            <a href="{{ url_for('network-security-setup') }}">network and security setup page</a>.
          </p>`);

        // Create the status summary.
        updateNetworkStatusSummary();

        // Create collapsible details container.
        const detailsContainer = $('<div id="network-details" class="collapse"></div>');
        container.append(detailsContainer);

        // Restore the expanded state from the variable.
        if (networkDetailsExpanded) {
          detailsContainer.addClass('show');
          setNetworkDetailToggleButton(true);
        }

        // Add detailed information, starting with device hosts information.
        if (isLocalAccess) {
          detailsContainer.append("<p>You are viewing this page on the device itself.</p>");
        }
        if (!networkInfo.device_hosts?.length) {
          detailsContainer.append("<p>Unfortunately, we have no information on other ways to reach this device.</p>");
        } else {
          if (isLocalAccess) {
            detailsContainer.append(
              "<p>This device is reachable on the network under these IP adresses/hostnames:</p>");
          } else {
            detailsContainer.append(
              `<p>
                This device is reachable on the network under these IP adresses/hostnames (we'll also check which of
                them can be reached from this browser):
              </p>`);
          }
          detailsContainer.append('<ul id="device-hosts-list" class="list-group list-group-small my-3"></ul>');
          for (const deviceHost of networkInfo.device_hosts) {
            let hostCommentHtml = "";
            if (deviceHost.type === "local_ip" && deviceHost.device_info.wifi) {
              hostCommentHtml = `wifi device <strong>${deviceHost.device_info.device}</strong> `;
              if (deviceHost.device_info.wifi.ssid) {
                hostCommentHtml += (
                  `connected to network <strong>${deviceHost.device_info.wifi.ssid}</strong> using the router
                  ${deviceHost.device_info.gateway}`);
              } else {
                hostCommentHtml += "not connected to a wifi network";
              }
            } else if (deviceHost.type === "local_ip") {
              hostCommentHtml = (
                `wired device <strong>${deviceHost.device_info.device}</strong> using the router
                ${deviceHost.device_info.gateway}`);
            } else if (deviceHost.type === "tailscale") {
              hostCommentHtml = "via Tailscale";
            }
            if (hostCommentHtml) {
              hostCommentHtml = ` (${hostCommentHtml})`;
            }
            const deviceHostsList = $("#device-hosts-list");
            deviceHostsList.append(
              `<li class="device-hosts-item list-group-item d-flex justify-content-between align-items-center px-2">
                <span>
                  <a href="http://${deviceHost.host}">${deviceHost.host}</a>${hostCommentHtml}
                </span>
              </li>`);
            if (!isLocalAccess) {
              deviceHostsList.find(".device-hosts-item").last().append(
                `<span class="badge badge-info rounded-pill feeder-reachability-badge" data-host="${deviceHost.host}" data-mdb-toggle="tooltip" title="Checking whether this address is reachable from this browser">
                  checking reachability...
                </span>`);
            }
          }
        }

        // Add external IP information.
        if (networkInfo.external_ip) {
          detailsContainer.append(
            `<p>
              This device's external IP (on the public internet) is <strong>${networkInfo.external_ip}</strong>
              <span id="feeder-external-ip-comment"></span>
            </p>`);
        } else {
          detailsContainer.append(
            `<p>
              Unfortunately, we have no information on the device's external IP (on the public internet).
            </p>`);
        }

        // Add alerts about issues with the network.
        const alertsContainer = $('<div class="row row-cols-1 row-cols-lg-2 g-3 m-3"></div>');
        alertsContainer.append(
          `<div class="col">
            <div class="alert alert-danger h-100">
              The firewall is disabled
              <span class="far fa-circle-question" data-mdb-toggle="tooltip" title="It is not possible to keep the firewall enabled with the current software"></span>
            </div>
          </div>`);
        if (networkInfo.hotspot_enabled) {
          alertsContainer.append(
            `<div class="col">
              <div class="alert alert-info h-100">
                The hotspot is enabled
                <span class="far fa-circle-question" data-mdb-toggle="tooltip" title="This device has started a hotspot that you can connect to in order to connect to a wifi"></span>
              </div>
            </div>`);
        }
        if (!networkInfo.has_internet && !networkInfo.has_router) {
          alertsContainer.append(
            `<div class="col">
              <div class="alert alert-danger h-100">
                The feeder has no internet connection.
              </div>
            </div>`);
        } else if (!networkInfo.has_internet ) {
          alertsContainer.append(
            `<div class="col">
              <div class="alert alert-danger h-100">
                The feeder can reach a router, but has no internet connection. That probably means that the router isn't
                online.
              </div>
            </div>`);
        }
        if (networkInfo.ipv6_broken) {
          alertsContainer.append(
            `<div class="col">
              <div class="alert alert-danger h-100">
                The feeder has an IPv6 address but IPv6 isn't working. This can cause docker and other issues.
              </div>
            </div>`);
        }
        if (!networkInfo.dns_is_working) {
          alertsContainer.append(
            `<div class="col">
              <div class="alert alert-danger h-100">
                The feeder cannot resolve DNS queries. This will most likely prevent it from working at all.
              </div>
            </div>`);
        }
        // This alert is hidden by default and only shown by setExternalIpComparisonComment().
        alertsContainer.append(
          `<div class="col" id="ip-mismatch-alert">
            <div class="alert alert-info h-100 d-none">
              The external IP of your browser and the feeder are different. The information in the status links for some
              of the aggregators below may be incorrect.
            </div>
          </div>`);
        detailsContainer.append(alertsContainer);

        // Initialize tooltips for newly added elements if there are any.
        const tooltips = container.find('[data-mdb-toggle="tooltip"]');
        tooltips.each(function() {
          initOrReplaceMdbTooltip(this);
        });

        // Ensure the connectivity checker for reachability badges is running.
        if (networkInfo.device_hosts?.length && !isLocalAccess) {
          const hosts = networkInfo.device_hosts.map(dh => dh.host);
          if (!connectivityChecker) {
            connectivityChecker = new FeederConnectivityChecker(hosts, updateRechabilityBadges, Infinity);
          }
          connectivityChecker.setHosts(hosts);
          updateRechabilityBadges();
          connectivityChecker.start();
        }
        if (networkInfo.external_ip) {
          setExternalIpComparisonComment(networkInfo.external_ip);
        }

        networkInfoUpdateCounter.reset();
      }).fail(function(jqXHR) {
        $("#network-info").html(makeNotificationCardRowHtml(
          "error", "Error getting network info", "Error getting network information from the feeder."));
      });
    }

    async function setExternalIpComparisonComment(feederExternalIp) {
      let browserIpData = fetch("https://api.ipify.org?format=json", { signal: AbortSignal.timeout(15000) })
        .then(response => response.json());
      const browserIp = (await browserIpData)["ip"];
      if (browserIp) {
        if (feederExternalIp == browserIp) {
          $("#feeder-external-ip-comment").text(" (that's the same as the one of this browser)");
          $("#ip-mismatch-alert").addClass("d-none");
        } else {
          $("#feeder-external-ip-comment").text(
            ` (that's a different one than the one of this browser, which has ${browserIp})`);
          $("#ip-mismatch-alert").removeClass("d-none");
        }
      } else {
          $("#feeder-external-ip-comment").text(" (we're unable to compare it to the browser's IP)");
          $("#ip-mismatch-alert").addClass("d-none");
        }
    }

    function updateRechabilityBadges() {
      let hasAnyReachableHost = false;
      let stillChecking = false;
      for ([host, {status, checkStart}] of connectivityChecker.getStati().entries()) {
        let badge = $(`.feeder-reachability-badge[data-host="${$.escapeSelector(host)}"`);
        if (!badge.length) continue;
        let badgeColorClass = "";
        if (status == "success") {
          badgeColorClass = "badge-success";
          badge.text("reachable");
          badge.attr("data-mdb-original-title", "This address is reachable from this browser");
          hasAnyReachableHost = true;
        } else if (Date.now() - checkStart > 10 * 1000) {
          badgeColorClass = "badge-danger";
          badge.text("not reachable");
          badge.attr("data-mdb-original-title", "This address is not reachable from this browser");
        } else {
          badgeColorClass = "badge-info";
          badge.text("checking reachability...");
          badge.attr(
            "data-mdb-original-title",
            "Checking whether this address is reachable from this browser");
          stillChecking = true;
          // Queue another check when the "not reachable" timeout is reached.
          const timeSinceCheckStart = Date.now() - checkStart;
          setTimeout(updateRechabilityBadges, 10 * 1000 - timeSinceCheckStart);
        }
        initOrReplaceMdbTooltip(badge[0]);
        let badgeColorClasses = new Set(["badge-info", "badge-success", "badge-warning", "badge-danger"]);
        badgeColorClasses.delete(badgeColorClass);
        badge.addClass(badgeColorClass);
        badge.removeClass(Array.from(badgeColorClasses).join(" "));
      }
      // Update the stored reachability state.
      lastReachabilityState.hasReachableHost = hasAnyReachableHost;
      lastReachabilityState.stillChecking = stillChecking;
      lastReachabilityState.lastChecked = Date.now();
      // Update the network status summary with the new reachability info.
      updateNetworkStatusSummary();
    }

    function updateSdrDevices() {
      $.ajax("/api/sdr_info").done(function (sdrInfo) {
        const row = $("#sdr-devices");
        row.html("");
        if (sdrInfo.missing_devices.length || sdrInfo.unconfigured_devices.length) {
          row.append(makeNotificationCardRowHtml(
            "error", "Configuration mismatch",
            "The devices that are configured don't match the ones that are attached."));
        }
        if (!sdrInfo.sdr_devices || !sdrInfo.sdr_devices.length) {
          row.append(makeNotificationCardRowHtml("info", "No devices", "No SDR devices are connected."));
        } else {
          for (const sdrDevice of sdrInfo.sdr_devices) {
            appendSdrDevice(sdrDevice);
          }
        }
        sdrDevicesUpdateCounter.reset();
      }).fail(function(jqXHR) {
        $("#sdr-devices").html(makeNotificationCardRowHtml(
          "error", "Error getting devices", "Error getting info about SDR devices from the feeder."));
      });
    }

    function appendSdrDevice(sdrDevice) {
      let usageDescriptionHtml = "unused";
      if (sdrDevice.assignment == "ais") {
        usageDescriptionHtml = "handling <strong>AIS</strong>";
      } else if (sdrDevice.assignment == "1090") {
        usageDescriptionHtml = "handling <strong>ADS-B (1090MHz)</strong>";
      } else if (sdrDevice.assignment == "978") {
        usageDescriptionHtml = "handling <strong>UAT (978MHz)</strong>";
      }
      $("#sdr-devices").append($(`
        <div class="col-12 col-lg-6">
          <div class="card my-2">
            <div class="card-body">
              <h5 class="card-title">Device with serial ${sdrDevice.serial}</h5>
              This is a ${sdrDevice.vendor} ${sdrDevice.product} which is ${usageDescriptionHtml}.
            </div>
          </div>
        </div>`));
    }

    function updateReceptionStats() {
      $.ajax("/api/stats").done(function (stats) {
        updateCurrentStats(stats);
        updateStatsHistory(stats);
        receptionUpdateCounter.reset();
      });
    }

    function updateCurrentStats(stats) {
      updateCurrentCraftStats("AIS", "ships", stats.ais, $(`#ais-stats`));
      updateCurrentCraftStats("ADS-B", "planes", stats.adsb, $(`#adsb-stats`));
    }

    function updateCurrentCraftStats(type, craftName, craftStats, element) {
      element.removeClass("alert-danger alert-success alert-warning");
      if (!craftStats.enabled) {
        element.addClass("alert-warning");
        element.html(`${type} reception is disabled.`);
      } else if (craftStats.current.pps > 0) {
        element.addClass("alert-success");
        element.html(
          `${type}: ${craftStats.current.pps.toFixed(1)} positions per second â€” `
          + `${craftStats.current.num} ${craftName} visible`);
      } else if (craftStats.uptime < 60) {
        element.addClass("alert-warning");
        element.html(
          `${type} reception has just been enabled, and we've not seen data arriving yet (let's wait a bit...)`);
      } else {
        element.addClass("alert-danger");
        element.html(`${type} reception is enabled, but no data is arriving.`);
      }
    }

    function updateStatsHistory(stats) {
      let light_distinct_colors = [
        "#61c8ff", "#f57200", "#025dfb", "#01d723", "#7300b3", "#a6e927", "#9055ff", "#d8c200",
        "#0039af", "#01db78", "#ff64f8", "#00560b", "#d60098", "#ade587", "#557bff", "#ffaf4c",
        "#6b91ff", "#9d1500", "#3ca4ff", "#574200", "#005296", "#ca0061", "#017960", "#ff8bc4",
        "#1a1a00", "#8ae3ec", "#50003d", "#e4d3b6", "#0f0021", "#ffbbca", "#4f1700", "#008b94"
      ];
      let dark_distinct_colors = [
        "#a94500", "#e1ffe9", "#960089", "#00633e", "#ffce63", "#015d92", "#ff76d4", "#e96200",
        "#ff96ae", "#a7d5ff", "#fdff90", "#bb61ff", "#4c5800", "#283e95", "#bd00e0", "#4fa900",
        "#f8a9ff", "#9dff2f", "#007380", "#4b4539", "#a1003c", "#ffe5cb", "#c00028", "#90af00",
        "#6cf7ff", "#0285fc", "#956900", "#ff1bd4", "#ff8f16", "#ff683c", "#890159", "#00d36d"
      ];
      let distinct_colors = [];
      if (document.documentElement.dataset.mdbTheme == "dark") {
        distinct_colors = dark_distinct_colors;
      } else {
        distinct_colors = light_distinct_colors;
      }
      let datasets = [];
      let colorIdx = 0;
      for (const [type, craftName, craftStats] of [["AIS", "ships", stats.ais], ["ADS-B", "planes", stats.adsb]]) {
        let posRateData = [], numData = [];
        for (const historyItem of craftStats.history) {
          const time = moment.unix(historyItem.ts);
          posRateData.push({x: time, y: historyItem.pps});
          numData.push({x: time, y: historyItem.num});
        }
        datasets.push({
          label: `${type} pos/s`,
          data: posRateData,
          borderColor: distinct_colors[colorIdx++ % distinct_colors.length],
          yAxisID: 'pps',
        });
        datasets.push({
          label: `number of ${craftName}`,
          data: numData,
          borderColor: distinct_colors[colorIdx++ % distinct_colors.length],
          yAxisID: 'num',
        });
      }
      receptionHistoryChart.data.datasets = datasets;
      updateChartWithShownIndices(receptionHistoryChart);
    }

    function updateAggregatorInfos() {
      $.ajax("/api/aggregators").done(function (aggregators) {
        $("#aggregators").html("");
        if (!aggregators.length) {
        $("#aggregators").html(makeNotificationCardRowHtml(
          "info", "No aggregators", "You are not sharing data with any aggregators."));
        } else {
          for (const agg of aggregators) {
            appendAggregatorInfo(agg);
          }
        }
        aggregatorUpdateCounter.reset();
      }).fail(function(jqXHR) {
        $("#aggregators").html(makeNotificationCardRowHtml(
          "error", "Error getting aggregator info", "Error getting info about aggregators from the feeder."));
      });
    }

    function appendAggregatorInfo(agg) {
      for (const [type, typeKey] of [["AIS", "ais"], ["ADS-B", "adsb"]]) {
        const status = agg[typeKey];
        if (!status) continue;
        let statusBadgeHtml = "";
        let dataStatusText = "";
        let mlatStatusHtml = "";
        // Data status.
        if (status.data_status == "good") {
          statusBadgeHtml = '<span class="badge rounded-pill badge-success">OK</span>';
          dataStatusText = "Data is arriving at the aggregator.";
        } else if (status.data_status == "warning") {
          statusBadgeHtml = '<span class="badge rounded-pill badge-warning">low data</span>';
          dataStatusText = "Data is arriving at the aggregator, but it doesn't seem to be a lot.";
        } else if (status.data_status == "bad") {
          statusBadgeHtml = '<span class="badge rounded-pill badge-danger">no data</span>';
          dataStatusText = "No data is arriving at the aggregator.";
        } else if (status.data_status == "starting") {
          statusBadgeHtml = '<span class="badge rounded-pill badge-info">starting...</span>';
          dataStatusText = "We've only just started sending data...";
        } else if (status.data_status == "container_down") {
          statusBadgeHtml = '<span class="badge rounded-pill badge-danger">container down</span>';
          dataStatusText = "The container sending data is down.";
        } else if (status.data_status == "disconnected") {
          statusBadgeHtml = '<span class="badge rounded-pill badge-danger">disconnected</span>';
          dataStatusText = "We're disconnected from the aggregator.";
        } else {
          statusBadgeHtml = '<span class="badge rounded-pill badge-info">no info</span>';
          dataStatusText = "We have no information whether data is arriving.";
        }
        // MLAT status.
        if (status.mlat_status == "good") {
          mlatStatusHtml = "MLAT is working.";
        } else if (status.mlat_status == "warning") {
          mlatStatusHtml = (
            "There are issues with MLAT (intermittent sync issue / lack of traffic / no other receivers in the area)");
        } else if (status.mlat_status == "bad") {
          mlatStatusHtml = (
            "MLAT is not working (if this persists for hours, check "
            + '<a href="https://github.com/wiedehopf/adsb-wiki/wiki/mlat-check">this page</a>)');
        } else if (status.mlat_status == "disconnected") {
          mlatStatusHtml = "MLAT is not connected.";
        } else if (status.mlat_status == "disabled") {
          mlatStatusHtml = "MLAT is disabled.";
        } else {
          mlatStatusHtml = "We have no information whether MLAT is working.";
        }
        // Append the card.
        $("#aggregators").append(`
          <div class="col-12 col-md-6">
            <div class="card my-2" id="${agg.agg_key}-${typeKey}-status">
              <div class="card-header"><strong>${type}</strong></div>
              <div class="card-body position-relative">
                <div class="position-absolute top-0 end-0 m-3">${statusBadgeHtml}</div>
                <h5 class="card-title">${agg.name}</h5>
                ${dataStatusText}
              </div>
              <div class="card-footer"></div>
            </div>
          </div>`);
        if (typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`<br> ${mlatStatusHtml}`);
        }
        // Add a footer with map and status URLs.
        const footer = $(`#${agg.agg_key}-${typeKey}-status > .card-footer`);
        if (agg.map_url) {
          footer.append(`<a href="${agg.map_url}" class="btn btn-secondary m-1" role="button">Aggregator map</a>`);
        } else {
          footer.append(
            `<a class="btn btn-secondary disabled m-1" role="button" aria-disabled="true">No aggregator map</a>`);
        }
        if (agg.status_url) {
          footer.append(
            `<a href="${agg.status_url}" class="btn btn-secondary m-1" role="button">Aggregator status</a>`);
        } else {
          footer.append(
            `<a class="btn btn-secondary disabled m-1" role="button" aria-disabled="true">No aggregator status map</a>`
          );
        }
        // Some extra info and links for particular aggregators.
        if (agg.agg_key == "adsblol" && typeKey == "adsb") {
          let mlatComment = "(your feeder will be at an approximate location as {{ get_conf('site_name') }})";
          if (agg.adsb.mlat_privacy) {
            mlatComment = "(since you have MLAT privacy enabled, your feeder won't be shown)";
          }
          let linkHtml = `<a href="${status.adsblol_link}">personal ADSB.lol URL with the planes you are sending</a>`;
          if (!status.adsblol_link) {
            linkHtml = (`
              <span class="text-muted" title="not available at the moment">
                personal ADSB.lol URL with the planes you are sending
              </span>`);
          }
          const lat = {{ get_conf('lat', default=0) }};
          const lon = {{ get_conf('lon', default=0) }};
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr hr-blurry">
            <h6>Information specific to adsb.lol</h6>
            <ul>
              <li><a href="https://status.adsb.lol/">ADSB.lol status</a></li>
              <li><a href="https://www.adsb.lol/docs/feeders-only/introduction/">ADSB.lol feeder introduction</a></li>
              <li>${linkHtml}</li>
              <li>
                <a href="https://mlat.adsb.lol/syncmap/#lat=${lat}#lon=${lon}#zoom=10">
                  ADSB.lol MLAT feeder map for the area around the device
                </a>
              </li>
            </ul>
            <p class="text-muted">${mlatComment}</p>`);
        } else if (agg.agg_key == "flightradar" && typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr hr-blurry">
            <h6>Information specific to flightradar24</h6>
            <ul>
              <li><a href="{{ url_for('flightaware-status') }}">flightradar24 status</a></li>
            </ul>`);
        } else if (agg.agg_key == "flightaware" && typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr hr-blurry">
            <h6>Information specific to FlightAware</h6>
            <ul>
              <li><a href="{{ url_for('flightaware-status') }}">FlightAware status</a></li>
            </ul>`);
        } else if (agg.agg_key == "planefinder" && typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr hr-blurry">
            <h6>Information specific to PlaneFinder</h6>
            <ul>
              <li><a href="{{ url_for('planefinder-map') }}">PlaneFinder map</a></li>
              <li><a href="{{ url_for('planefinder-status') }}">PlaneFinder stats</a></li>
            </ul>`);
        } else if (agg.agg_key == "adsbx" && typeKey == "adsb") {
          let linksHtml = (`
            <li>
              <a href="https://www.adsbexchange.com/api/feeders/?feed=${status.adsbx_feeder_id}">
                ADSBx Anywhere Stats
              </a>
            </li>
            <li><a href="https://globe.adsbexchange.com/?feed=${status.adsbx_feeder_id}">ADSBx Anywhere Map</a></li>`);
          if (!status.adsbx_feeder_id) {
            linksHtml = (`
            <li><span class="text-muted" title="not available at the moment">ADSBx Anywhere Stats</span></li>
            <li><span class="text-muted" title="not available at the moment">ADSBx Anywhere Map</span></li>`);
          }
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr hr-blurry">
            <h6>Information specific to ADSBExchange</h6>
            <ul>${linksHtml}</ul>`);
        } else if (agg.agg_key == "alive" && typeKey == "adsb") {
          let linkHtml = `<a href="${status.alive_map_link}">Map</a>`;
          if (!status.alive_map_link) {
            linkHtml = `<span class="text-muted" title="not available at the moment">Map</span>`;
          }
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr hr-blurry">
            <h6>Information specific to airplanes.live</h6>
            <ul>
              <li><a href="https://airplanes.live/myfeed/">Status</a></li>
              <li><a href="${status.alive_map_link}">Map</a></li>
            </ul>`);
        }
      }
    }

    function updateVersionInfo(versionInfo) {
        $.ajax("/api/version-info").done(function (versionInfo) {
          $("#version-info").html(`<p>This device is currently running <strong>${versionInfo.version}</strong></p>`);
          if (versionInfo.version == versionInfo.stable_versions[0]) {
            $("#version-info p").append(" (this is the latest stable version)");
          } else {
            $("#version-info p").append(`
              (the latest stable version is <strong>${versionInfo.stable_versions[0]}</strong>, see `
              + '<a href="{{ url_for('system-setup') }}">system management</a> for update)');
          }
          $("#version-info").append(`
            These Docker containers belong to the application (see <a href="{{ url_for('dozzle') }}">Dozzle</a> for
            details):
            <div id="docker-containers" class="row"></div>`);
          for (const container of versionInfo.containers) {
            let statusBadgeHtml = '<span class="badge rounded-pill badge-success">running</span>';
            if (["created", "paused", "exited"].includes(container.state)) {
              statusBadgeHtml = `<span class="badge rounded-pill badge-info">${container.state}</span>`;
            } else if (container.state == "restarting") {
              statusBadgeHtml = '<span class="badge rounded-pill badge-warning">restarting</span>';
            } else if (container.state == "dead") {
              statusBadgeHtml = '<span class="badge rounded-pill badge-danger">dead</span>';
            } else if (container.status.includes("unhealthy")) {
              statusBadgeHtml = '<span class="badge rounded-pill badge-danger">unhealthy</span>';
            }
            $("#docker-containers").append(`
            <div class="col-12 col-md-6">
              <div class="card my-2">
                <div class="card-body">
                  <div class="position-absolute top-0 end-0 m-3">${statusBadgeHtml}</div>
                  <h5 class="card-title">${container.name}</h5>
                  ${container.status}
                </div>
                <div class="card-footer text-muted">${container.image}</div>
              </div>
            </div>`);
          }
          versionUpdateCounter.reset();
        }).fail(function(jqXHR) {
          $("#version-info").html(makeNotificationCardRowHtml(
            "error", "Error getting version info", "Error getting info about software versions from the feeder."));
        });
    }

    function updateOtherFeeders(versionInfo) {
        $.ajax("{{ url_for('feeder_discovery') }}").done(function (otherFeeders) {
          if (!otherFeeders.length) {
            $("#device-discovery").html(makeNotificationCardRowHtml(
              "info", "No other devices", "No other Porttracker SDR devices have been found on the network."));
          } else {
            $("#device-discovery").html(`
              <p>${otherFeeders.length} other device(s) have been found on the network.</p>
              <div id="other-devices"></div>`);
            for (const feeder of otherFeeders) {
              const card = $(`
                <div class="col-12 col-xl-6">
                  <div class="card my-2">
                    <div class="card-body">
                      <h5 class="card-title">${feeder.name}</h5>
                      <ul class="device-link-list"></ul>
                    </div>
                  </div>
                </div>`);
              for (const host of [`${feeder.name}.local`].concat(feeder.ip_addresses)) {
                card.find(".device-link-list").append(`<li><a href="http://${host}">http://${host}</a></li>`);
              }
              card.appendTo("#other-devices");
            }
          }
          otherFeederUpdateCounter.reset();
        }).fail(function(jqXHR) {
          $("#device-discovery").html(makeNotificationCardRowHtml(
            "error", "Error getting other devices",
            "Error getting info about other Porttracker SDR devices on the network."));
        });
    }

    const networkInfoUpdateCounter = new UpdateTimeCounter(
      "last-update-network-info-counter", "last-update-network-info-button");
    const sdrDevicesUpdateCounter = new UpdateTimeCounter(
      "last-update-sdr-devices-counter", "last-update-sdr-devices-button");
    const receptionUpdateCounter = new UpdateTimeCounter(
      "last-update-reception-counter", "last-update-reception-button");
    const aggregatorUpdateCounter = new UpdateTimeCounter(
      "last-update-aggregators-counter", "last-update-aggregators-button");
    const versionUpdateCounter = new UpdateTimeCounter(
      "last-update-version-counter", "last-update-version-button");
    const otherFeederUpdateCounter = new UpdateTimeCounter(
      "last-update-device-discovery-counter", "last-update-device-discovery-button");
    registerTask("Update network info", 60000, updateNetworkInfo);
    registerTask("Update SDR devices", 15000, updateSdrDevices);
    registerTask("Update reception stats", 15000, updateReceptionStats);
    registerTask("Update aggregator infos", 60000, updateAggregatorInfos);
    registerTask("Update version info", 60000, updateVersionInfo);
    registerTask("Update other feeder info", 60000, updateOtherFeeders);
  </script>
{% endblock content %}
