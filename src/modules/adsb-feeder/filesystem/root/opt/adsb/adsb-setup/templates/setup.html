{% extends "base-regular.html" %}
{% set active_page = "setup" %}
{% block title %}
  Setup required parameters
{% endblock title %}
{% block content %}
  <div class="{%- if get_conf('dns_state') %} d-none {%- endif -%}">
    <div class="alert alert-danger" role="alert">
      The feeder cannot resolve DNS queries. This will most likely prevent it from working at all.
    </div>
  </div>
  <form method="post" onsubmit="showSpinner(); return true;">
    <div class="card my-2">
      <div class="card-body">
        <h5 class="card-title">Basic parameters</h5>
        <p>
          The data below should match the exact location of your antenna. You can use the
          <a href="https://www.freemaptools.com/elevation-finder.htm"
             target="_blank">location and elevation finder tool</a> to find your Latitude, Longitude, and Altitude based
          on your address.
        </p>
        <div class="row align-items-center">
          <div class="col-12 col-lg-6">
            <p>
              If you are re-installing the Porttracker SDR Feeder and have made a backup of your configuration, you can also
              simply restore those settings.
            </p>
          </div>
          <div class="col-12 col-lg-6">
            <a class="btn btn-secondary" href="{{ url_for('backup') }}">Restore previous backup</a>
          </div>
        </div>
        <div class="form-group">
          <div class="row my-1 align-items-center">
            <div class="col-12 col-lg-6">
              <label for="station-name">Station Name (shows up on public maps if enabled later)</label>
            </div>
            <div class="col-12 col-lg-6">
              <input type="text"
                     id="station-name"
                     name="station-name"
                     required
                     placeholder="my-awesome-antenna"
                     class="form-control"
                     pattern="[\-_.a-zA-Z0-9 ]+"
                     title="Letters, numbers, -, _, ."
                     value="{{ get_conf('site_name', default='') }}">
            </div>
          </div>
        </div>
        <div class="form-group">
          <div class="row my-1 align-items-center">
            <div class="col-12 col-lg-6">
              <label for="latitude">Latitude (-90 .. +90 -- please use 5 decimals, e.g. 45.12345)</label>
            </div>
            <div class="col-12 col-lg-6">
              <input type="text"
                     id="latitude"
                     name="latitude"
                     required
                     placeholder="Antenna latitude"
                     class="form-control"
                     pattern="(?:\+|-|)(?:(?:[0-8]?\d)(?:\.\d+)?|90(?:\.0+)?)(,(?:\+|-|)(:?(:?\d?\d|1[0-7]\d)(?:\.\d+)?|180(?:\.0+)?))?"
                     title="Number between -90 and 90"
                     value="{{ get_conf('lat', default='') }}">
            </div>
          </div>
        </div>
        <div class="form-group">
          <div class="row my-1 align-items-center">
            <div class="col-12 col-lg-6">
              <label for="longitude">Longitude (-180 .. +180 -- please use 5 decimals , e.g. -122.12345)</label>
            </div>
            <div class="col-12 col-lg-6">
              <input type="text"
                     id="longitude"
                     name="longitude"
                     required
                     placeholder="Antenna longitude"
                     class="form-control"
                     pattern="(?:\+|-|)(:?(:?\d?\d|1[0-7]\d)(?:\.\d+)?|180(?:\.0+)?)"
                     title="Number between -180 and 180"
                     value="{{ get_conf('lon', default='') }}">
            </div>
          </div>
        </div>
        <div class="form-group">
          <div class="row my-1 align-items-center">
            <div class="col-12 col-lg-6">
              <label for="altitude">Altitude above mean sealevel, rounded to whole meters</label>
            </div>
            <div class="col-12 col-lg-6">
              <input type="text"
                     id="altitude"
                     name="altitude"
                     required
                     placeholder="in m - or add 'ft' to enter in ft"
                     class="form-control"
                     pattern="(?:\+|-|)\d+(?:m|ft)"
                     value="{{ get_conf('alt', default='') }}">
            </div>
          </div>
        </div>
        <div class="form-group">
          <div class="row my-1 align-items-center">
            <div class="col-12 col-lg-6">
              <div class="d-flex align-items-center">
                <label for="timezone">Timezone</label>
                <button class="btn btn-secondary ms-5"
                        onclick="useBrowserTimezone(); return false; // return false inhibits the form to be submitted">
                  Update timezone
                </button>
              </div>
            </div>
            <div class="col-12 col-lg-6">
              <input type="text"
                     name="timezone"
                     id="timezone"
                     required
                     placeholder="populate from the browser timezone by clicking the 'update timezone' button"
                     class="form-control "
                     value="{{ get_conf('tz', default='') }}">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card my-2">
      <div class="card-body">
        <h5 class="card-title">Bulk aggregator selection</h5>
        <p>
          Here you can conveniently select many aggregators with one click (this only works for ADS-B aggregators that don't
          require any registration). Check the boxes below to send data to all account-less aggregators, or to those that
          have a privacy policy. You can also make this choice later or disable individual aggregators on the data sharing
          setup page.
        </p>
        <div class="form-check">
          <input type="checkbox"
                 name="enable-all-aggregators"
                 id="enable-all-aggregators"
                 class="form-check-input">
          <label class="form-check-label" for="enable-all-aggregators">
            Enable all aggregators that don't require accounts
          </label>
        </div>
        <div class="form-check">
          <input type="checkbox"
                 name="enable-aggregators-with-privacy"
                 id="enable-aggregators-with-privacy"
                 class="form-check-input">
          <label class="form-check-label" for="enable-aggregators-with-privacy">
            Enable all aggregators that don't require accounts and have a privacy policy
          </label>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-accent btn-block btn-lg my-5">Submit</button>
  </form>
  <script>
    function fixAlt() {
      let altValue = $("#altitude").val();
      let factor = 1.0;
      if (altValue.toLowerCase().includes("ft")) factor = 0.3048;
      let fixedAlt = Math.round(parseFloat(altValue) * factor);
      if (fixedAlt.toString() == "NaN") fixedAlt = "";
      else fixedAlt = fixedAlt + "m";
      $("#altitude").val(fixedAlt);
    }
    fixAlt();
    $("#altitude").on("blur", fixAlt);

    function getBrowserTimezone() {
      let timezone = "";
      try {
        timezone = Intl.DateTimeFormat("en-US").resolvedOptions().timeZone;
      } catch (error) {
        console.error(`Error finding the browser timezone: ${error}`);
      }
      return timezone;
    }

    function useBrowserTimezone() {
      $("#timezone").val(getBrowserTimezone());
    }
    // Set timezone field to browser timezone if not set already.
    if (!$("#timezone").val()) {
      useBrowserTimezone();
    }
  </script>
{% endblock content %}
