{% extends "base-regular.html" %}
{% set active_page = "overview" %}
{% block title %}
  Porttracker Feeder Homepage
{% endblock title %}
{% block content %}
  <div class="alert alert-danger {% if env_value_by_tag('dns_state') %}d-none{% endif %}"
       role="alert">The feeder cannot resolve DNS queries. This will most likely prevent it from working at all.</div>
  <div class="alert alert-danger {% if not ipv6_broken %}d-none{% endif %}"
       role="alert">
    The feeder has an IPv6 address but IPv6 isn't working. This can cause docker and other issues.
  </div>
  <div class="alert alert-danger {% if not compose_up_failed %}d-none{% endif %}"
       role="alert">
    docker compose up has failed. This means that something is wrong.
    <form method="post">
      <button type="submit" name="submit" value="go" class="btn btn-primary">Retry</button>
    </form>
  </div>
  <div class="alert alert-danger {% if not env_value_by_tag('under_voltage') %}d-none{% endif %}"
       role="alert">
    The feeder system kernel detected under-voltage. This can lead to random crashes and various issues with clock
    stability, reduced reception, failing SDRs, etc. Please check and likely replace your power supply.
  </div>
  <div id="ip-mismatch" class="alert alert-info d-none" role="alert">
    The external IP of your browser and the feeder are different. The information in the status links for some of the
    aggregators below may be incorrect.
  </div>
  <div id="low-disk"
       class="alert alert-info {% if not env_value_by_tag('low_disk') %}d-none{% endif %}"
       role="alert">
    You are running low on disk space on the your feeder. This can lead to odd problems and even crashes. Consider
    upgrading to a larger storage device.
  </div>
  <div class="col-12 mb-3">hostname {{ list_value_by_tag('site_name', 0) }}</div>
  <div id="plane-stats" class="col-12 mb-3">
    Position / Message rate: 
    <span id="mf_status_0"></span> â€” <span id="mf_stats_0"></span>
</div>
<div class="col-12 mb-3">
  AIS Message rate:
  <span id="ais_msg_rate" class="fw-bold">--</span>
  â€” Vessels (last min):
  <span id="ais_vessel_count" class="fw-bold">--</span>
</div>
<div id="chart-wrapper"
     class="col-md-10 col-12"
     style="position: relative;
            width: 100%;
            height: 100%">
  <canvas id="reception-history-chart"></canvas>
</div>
<div class="col-12 {% if (aggregators | length) == 0 %}d-none{% endif %}">
  <h4>You are feeding</h4>
  <div class="row small">
    {% for tc in agg_tables %}
      <div class="col-12 col-md-6" style="overflow-x: auto">
        <table class="table table-bordered table-sm lh-1 table-striped">
          <thead>
            <td style="position: -webkit-sticky; position: sticky; left: 0px;">Aggregator</td>
            <td class="text-center" colspan="1">Enabled</td>
            <td class="text-center" colspan="1">Data</td>
            <td class="text-center" colspan="1">MLAT</td>
            <td class="text-center" colspan="1">Status</td>
          </thead>
          <tbody>
            {% for agg, name, map, status, table in aggregators %}
              {% if (tc == table) %}
                <tr>
                  <td style="position: -webkit-sticky; position: sticky; left: 0px;">
                    <a href="{{ map }}">{{ name }}</a>
                  </td>
                  <td class="text-center">
                    <span id="{{ agg ~ 'span' ~ 0 }}" width="3em">
                      {% if list_is_enabled(agg, 0) %}âœ“{% endif %}
                    </span>
                  </td>
                  <td class="text-center">
                    <span id="{{ agg ~ 'beast' ~ 0 }}" width="3em"></span>
                  </td>
                  <td class="text-center">
                    <span id="{{ agg ~ 'mlat' ~ 0 }}" width="3em"></span>
                  </td>
                  <td class="text-center">
                    {% if status[0] != "" and list_is_enabled(agg, 0) %}<a href="{{ status[0] }}">ðŸ”—</a>{% endif %}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
    <div class="col-12 mb-4">
      Enabled indicates feeding the aggregator. <span class="text-success">âœ“</span> feed is in good state,
      <span class="text-danger">âœ“</span> feed is down,
      <span class="text-warning">âœ“</span> feed is degraded,
      <span class="text-muted">âœ“</span> feed state is not supported
      <br />
      <span onclick="$('#extra_legend').toggleClass('d-none'); return false;">
        <a href="">Toggle detailed legend</a>
      </span>
      <span>| Last status update: <span id="last_status_update"></span></span>
      <br />
      <span class="d-none" id="extra_legend">
        '+': feed/mlat is connected; 'â˜’': feed/mlat is not connected
        <br />
        'â˜¹': mlat sync errors (if this persists for hours, check <a href="https://github.com/wiedehopf/adsb-wiki/wiki/mlat-check">this page</a>)
        <br />
        'âš ': feed is intermittent / degraded
        <br />
        'âš ': mlat sync warning (intermittent sync issue / lack of traffic / no other receivers in the area)
        <br />
        'âŸ³': container is up for less than a 30 seconds, not checking status
        <br />
        'â˜ˆ': container is down
        <br />
        '.': status information is not available at this time or not supported
      </span>
    </div>
  </div>
</div>
<div class="col-12 mb-4 {% if env_value_by_tag('aggregator_choice') in ['micro', 'nano'] %}d-none{% endif %}">
  <div class="small">
    {% if (aggregators | length) == 0 %}
      No aggregators configured. Add aggregators:
    {% else %}
      Add or remove aggregators:
    {% endif %}
    <a href="{{ url_for('aggregators') }}">Data Sharing</a>
  </div>
</div>
<div class="col-12 mb-4">
  {% with current_version = env_value_by_tag("base_version") %}
    Running Porttracker Feeder version <strong>{{ current_version }}</strong>
    {% if current_version == tags[0] %}
      (this is the latest stable version)
    {% else %}
      (latest stable version is <strong>{{ tags[0] }}</strong>, see
      <a href="{{ url_for('systemmgmt') }}">system management</a> for update)
    {% endif %}
  {% endwith %}
</div>
<div class="col-12">
  <ul>
    <li>
      <span style="display: inline-block; width: 6em;"><strong>Feeder version:</strong></span> {{ version }}
    </li>
    <li>
      <span style="display: inline-block; width: 6em;"><strong>Board:</strong></span> {{ board }}
    </li>
    <li>
      <span style="display: inline-block; width: 6em;"><strong>Base:</strong></span> {{ base }}
    </li>
    <li>
      <strong>Containers:</strong>
      <ul>
        {% for container in containers %}
          <li>{{ container }}</li>
        {% endfor %}
      </ul>
    </li>
    <li>
      <strong>SDR(s):</strong>
      {% if sdrs %}
        <ul>
          {% for sdr in sdrs %}
            <li>
              <pre>{{ sdr }}</pre>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        no SDRs connected
      {% endif %}
    </li>
  </ul>
</div>
<script src="/static/js/chart.js"
        integrity="sha256-QvTb/nDEMP/CLHEo82yujVmcrJC4zTfI9CpZ5WXl3rc="
        crossorigin="anonymous"></script>
<script>
  function createReceptionHistoryChart(len) {
    let context = document.getElementById("reception-history-chart");
    return new Chart(context, {
      type: 'line',
      data: {
        labels: [],
        datasets: []
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: "Reception statistics",
            font: {
              size: 18,
            }
          },
          legend: {
            onClick: function (e, legendItem) {
              let index = legendItem.datasetIndex;
              let adding = e.native.shiftKey == false;
              if (adding && shownIndices.size == 0) {
                // invert
                for (let i = 0; i < len; i++) {
                  if (i != index) {
                    shownIndices.add(i);
                  }
                }
              } else {
                if (shownIndices.has(index)) {
                  shownIndices.delete(index);
                } else {
                  shownIndices.add(index);
                }
              }
              if (shownIndices.size == len) shownIndices = new Set();
              clear = shownIndices.size == 0;
              let ci = this.chart;
              for (let i = 0; i < len; i++) {
                let meta = ci.getDatasetMeta(i);
                meta.hidden = (clear ? false : (!shownIndices.has(i)));
              }
              // We hid a dataset ... rerender the chart
              ci.update();
            },
            labels: {
              boxWidth: 20,
              useBorderRadius: true,
              borderRadius: 2
            }
          }
        },
        scales: {
          x: {type: "linear"},
          y: {
            type: "linear",
            display: true,
            position: "left",
            beginAtZero: true,
          },
          y1: {
            type: "linear",
            display: true,
            position: "right",
            beginAtZero: true,
            grid: {
              drawOnChartArea: false, // Only show grid lines for one axis.
            },
          },
        }
      }
    });
  }
  function updateCurrentStats(stats) {
    let color_class = "text-danger";
    let tooltip = "not receiving any data"
    if (stats.planes.current["pps"] > 0) {
      color_class = "text-success";
      tooltip = "receiving data (plane total since midnight UTC)"
    } else if (true || stats.planes.current["uptime"] > 60) {
      color_class = "text-warning";
      tooltip = "receiving unusually little data"
    }
    $("#plane-stats").removeClass("text-danger text-success text-warning");
    $("#plane-stats").addClass(color_class);
    $("#plane-stats").attr('title', tooltip);
    $("#mf_status_0").text(`${stats.planes.current.pps} positions per second`);
    $("#mf_stats_0").text(`${stats.planes.current.num} planes at the moment`);
}

  let shownIndices = new Set();
  let receptionHistoryChart = createReceptionHistoryChart(4);
  function updateAisStats() {

    const aisEndpoint =
      `${window.location.protocol}//${window.location.hostname}:{{ env_value_by_tag('aiscatcherport') }}/api/stat.json`;

    fetch(aisEndpoint, { signal: AbortSignal.timeout(15000) })
      .then(r => r.json())
      .then(d => {
        const msgRate = (d.msg_rate ?? 0).toFixed(1) + " msg/s";
        const vessels = d.last_minute?.vessels ?? d.vessel_count ?? 0;

        document.getElementById("ais_msg_rate").textContent = msgRate;
        document.getElementById("ais_vessel_count").textContent = vessels;
      })
      .catch(err => console.error("AIS stats fetch failed:", err));
  }

  function updateStatsHistory(stats) {
    let light_distinct_colors = [
      "#61c8ff", "#f57200", "#025dfb", "#01d723", "#7300b3", "#a6e927", "#9055ff", "#d8c200",
      "#0039af", "#01db78", "#ff64f8", "#00560b", "#d60098", "#ade587", "#557bff", "#ffaf4c",
      "#6b91ff", "#9d1500", "#3ca4ff", "#574200", "#005296", "#ca0061", "#017960", "#ff8bc4",
      "#1a1a00", "#8ae3ec", "#50003d", "#e4d3b6", "#0f0021", "#ffbbca", "#4f1700", "#008b94"
    ];
    let dark_distinct_colors = [
      "#a94500", "#e1ffe9", "#960089", "#00633e", "#ffce63", "#015d92", "#ff76d4", "#e96200",
      "#ff96ae", "#a7d5ff", "#fdff90", "#bb61ff", "#4c5800", "#283e95", "#bd00e0", "#4fa900",
      "#f8a9ff", "#9dff2f", "#007380", "#4b4539", "#a1003c", "#ffe5cb", "#c00028", "#90af00",
      "#6cf7ff", "#0285fc", "#956900", "#ff1bd4", "#ff8f16", "#ff683c", "#890159", "#00d36d"
    ];
    let distinct_colors = [];
    if (document.documentElement.dataset.mdbTheme == "dark") {
      distinct_colors = dark_distinct_colors;
    } else {
      distinct_colors = light_distinct_colors;
    }
    let datasets = [];
    let colorIdx = 0;
    for (const [craftName, craftStats] of [["ships", stats.ships], ["planes", stats.planes]]) {
      let posRateData = [], numData = [];
      for (const historyItem of craftStats.history) {
        posRateData.push({x: historyItem.ts, y: historyItem.pps});
        numData.push({x: historyItem.ts, y: historyItem.num});
      }
      datasets.push({
        label: `${craftName} pos/s`,
        data: posRateData,
        borderColor: distinct_colors[colorIdx++ % distinct_colors.length],
        yAxisID: 'y',
      });
      datasets.push({
        label: `number of ${craftName}`,
        data: numData,
        borderColor: distinct_colors[colorIdx++ % distinct_colors.length],
        yAxisID: 'y1',
      });
    }
    receptionHistoryChart.data.datasets = datasets;
    receptionHistoryChart.update();
  }
  let browser_ip = null;
  let feeder_ip = null;
  let ip_message = "";
  function compareIps() {
    if (feeder_ip == null || browser_ip == null) {
      return;
    }
    if (browser_ip != feeder_ip) {
      let new_ip_message = ["IP check: browser got", browser_ip, "feeder has", feeder_ip].join(" ");
      if (new_ip_message != ip_message) {
        ip_message = new_ip_message;
        console.log(ip_message);
      }
      $("#ip-mismatch").show();
    } else {
      $("#ip-mismatch").hide();
    }
  }

  function reset_status(agg, idx) {
    $("#" + agg + "beast" + idx).text(".");
    $("#" + agg + "mlat" + idx).text(".");
    $("#" + agg + "span" + idx).attr("class", "text-muted");
  }
  function get_status(agg) {
    fetch(`/api/status/${agg}`, { signal: AbortSignal.timeout(15000) })
      .then(response => response.json())
      .then(dict => {
        Object.keys(dict).forEach(idx => {
          const data = dict[idx];
          // now use the idx to do something clever about what is shown there...
          // right now this is broken and just overwrites things
          $("#" + agg + "beast" + idx).text(data["beast"]);
          $("#" + agg + "mlat" + idx).text(data["mlat"]);
          const mlat_broken = !(data["mlat"] == "+" || data["mlat"] == "." || data["mlat"] == " ");
          const beast_broken = !(data["beast"] == "+" || data["beast"] == "." || data["beast"] == " ");
          if (data["beast"] == "+" && !mlat_broken) {
            $("#" + agg + "span" + idx).attr("class", "text-success");
          } else if (data["beast"] == "â˜’") {
            $("#" + agg + "span" + idx).attr("class", "text-danger");
          } else if (beast_broken || mlat_broken) {
            $("#" + agg + "span" + idx).attr("class", "text-warning");
          } else {
            $("#" + agg + "span" + idx).attr("class", "text-muted");
          }
          if (agg == "adsblol") {
            // console.log("set adsblol-link" + idx + " to " + data["adsblollink"])
            $("#adsblol-link-" + idx).attr("href", data["adsblollink"]);
          }
          if (agg == "alive") {
            $("#alivemaplink_" + idx).attr("href", data["alivemaplink"]);
          }
          if (agg == "adsbx") {
            if (idx == 0) {
              $("#adsbxstatlink").attr("href", "https://www.adsbexchange.com/api/feeders/?feed=" + data["adsbxfeederid"]);
              $("#adsbxmaplink").attr("href", "https://globe.adsbexchange.com/?feed=" + data["adsbxfeederid"]);
            } else {
              // console.log("set adsbxstatlink" + idx)
              $("#adsbxstatlink_" + idx).attr("href", "https://www.adsbexchange.com/api/feeders/?feed=" + data["adsbxfeederid"]);
              $("#adsbxmaplink_" + idx).attr("href", "https://globe.adsbexchange.com/?feed=" + data["adsbxfeederid"]);
            }
          }
        });
      });
  }

  registerTask(
    "Update reception stats",
    15000,
    function() {
      fetch("/api/stats", {signal: AbortSignal.timeout(2000)})
      .then(response => response.json())
      .then(stats => {
        updateCurrentStats(stats);
        updateStatsHistory(stats);
      });
    }
  );

  registerTask(
    "Update IP info and aggregator status",
    30000,
    function() {
      $("#last_status_update").html(new Date().toLocaleTimeString());

      fetch("https://api.ipify.org?format=json", { signal: AbortSignal.timeout(15000) })
        .then(response => response.json())
        .then(data => {
          browser_ip = data["ip"];
          compareIps();
        });
      fetch("/api/ip_info", { signal: AbortSignal.timeout(15000) })
        .then(response => response.json())
        .then(data => {
          feeder_ip = data["feeder_ip"];
          compareIps();
        });
      {% for agg, name, m, s, table in aggregators %}
        {% if list_is_enabled(agg, 0) and matrix[0] > 0 %}
          reset_status("{{ agg }}", 0);
          get_status("{{ agg }}");
        {% endif %}
      {% endfor %}
    }
  );
</script>
{% endblock content %}
