{% extends "base-container.html" %}
{% set active_page = "hotspot" %}
{% block title %}
  Trying to connect to WiFi
{% endblock title %}
{% block content %}
  <!-- Explanatory Text -->
  <div class="alert alert-info mb-4" role="alert">
    <h5 class="alert-heading">Device Restart in Progress</h5>
    <p class="mb-0">
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
      The device is restarting and attempting to connect to the configured network. This process may take a few minutes.
    </p>
  </div>
  <!-- Progress Steps -->
  <div class="card">
    <ul class="list-group list-group-light list-group-flush px-4">
      <li class="list-group-item py-3" id="step-1">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-flex align-items-start flex-grow-1">
            <span class="step-icon far fa-circle text-muted me-3 mt-1"></span>
            <div class="flex-grow-1">
              <div class="fw-bold mb-1">Stop the hotspot</div>
              <div class="step-description text-muted small">
                The device has received the network SSID and password you provided. Now it has has to stop the hotspot
                we were just connected to so it can try to connect to the network. This means we will be disconnected
                from the hotspot for a few seconds.
              </div>
            </div>
          </div>
          <span class="step-badge badge badge-secondary rounded-pill ms-3">Pending</span>
        </div>
      </li>
      <li class="list-group-item py-3 text-muted" id="step-2">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-flex align-items-start flex-grow-1">
            <span class="step-icon far fa-circle text-muted me-3 mt-1"></span>
            <div class="flex-grow-1">
              <div class="fw-bold mb-1">Connect to the network</div>
              <div class="step-description text-muted small">
                The device uses the network SSID and password you provided to connect to the network. This browser
                window will keep trying to reach the device. This should work if the device manages to connect, and this
                browser is connected to the same network.
              </div>
            </div>
          </div>
          <span class="step-badge badge badge-secondary rounded-pill ms-3">Pending</span>
        </div>
      </li>
      <li class="list-group-item py-3 text-muted" id="step-3">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-flex align-items-start flex-grow-1">
            <span class="step-icon far fa-circle text-muted me-3 mt-1"></span>
            <div class="flex-grow-1">
              <div class="fw-bold mb-1">Connection established</div>
              <div class="step-description text-muted small">
                We've heard back from the device, and it is successfully connected to the network.
              </div>
            </div>
          </div>
          <span class="step-badge badge badge-secondary rounded-pill ms-3">Pending</span>
        </div>
      </li>
    </ul>
  </div>
  <!-- Status Message -->
  <div class="alert alert-warning mt-4 d-none"
       role="alert"
       id="timeout-message">
    <span class="fas fa-exclamation-triangle me-2"></span>
    Device has probably joined the configured network!
  </div>
  <script>
    let currentStep = 1;
    let checkTimeoutId = undefined;
    const startTime = Date.now();

    function updateStepStatus(stepNumber, status) {
      if (!["done","error","in-progress"].includes(status)) {
        console.error(`Invalid step status: ${status}`);
        return;
      }
      const stepElement = $(`#step-${stepNumber}`);
      const iconElement = stepElement.find(".step-icon");
      const badgeElement = stepElement.find(".step-badge");
      const descriptionElement = stepElement.find(".step-description");

      // Remove text-muted class to make it visible
      stepElement.removeClass("text-muted");
      iconElement.removeClass(
        "far fas fa-circle fa-circle-check fa-circle-notch fa-circle-xmark fa-spin text-muted text-success text-danger "
          + "text-primary");
      badgeElement.removeClass("badge-secondary badge-success badge-danger badge-primary");
      descriptionElement.removeClass("text-muted");

      if (status === "done") {
        // Green checkmark for completed steps
        iconElement.addClass("far fa-circle-check text-success");
        badgeElement.addClass("badge-success");
        badgeElement.text("Done");
      } else if (status === "error") {
        // Red X for failed steps
        iconElement.addClass("far fa-circle-xmark text-danger");
        badgeElement.addClass("badge-danger");
        badgeElement.text("Failed");
      } else if (status === "in-progress") {
        // Spinning icon for current step
        iconElement.addClass("fas fa-circle-notch fa-spin text-primary");
        badgeElement.addClass("badge-primary");
        badgeElement.text("In Progress");
      }
    }

    function simulateProgress() {
      // This is a placeholder - you can replace this with actual progress tracking
      // based on the response from checkRestartStatus()
      if (currentStep < 3) {
        if (currentStep > 0) {
          updateStepStatus(currentStep, "done");
        }
        currentStep++;
        updateStepStatus(currentStep, "in-progress");
      }
    }

    function after60() {
      // Show timeout message after 60 seconds
      document.getElementById("timeout-message").classList.remove("d-none");
    }

    function checkRestartStatus() {
      $.ajax({
        url: "http://{{ get_conf("feeder_name") }}.local/api/statusz",
        type: "GET",
        timeout: 200,
        success: function (feederStatus) {
          updateStatus(feederStatus, undefined);
        },
        error: function (jqXHR, textStatus, errorThrown) {
          updateStatus(undefined, textStatus);
        },
      });
      checkTimeoutId = setTimeout(checkRestartStatus, 200);
    }

    function updateStatus(feederStatus, errorStatus) {
      while (true) {
        switch (currentStep) {
          case 1:
            // Step 1: Stop the hotspot
            // We need to see that the device is disconnected (timeout) or no longer in hotspot mode
            if (errorStatus === "timeout" || errorStatus === "error") {
              console.log("Step 1: Can't reach the device, hotspot must have stopped. Progressing to step 2.");
              updateStepStatus(currentStep, "done");
              currentStep++;
              updateStepStatus(currentStep, "in-progress");
              // Continue to check step 2
            } else if (feederStatus?.mode === "hotspot") {
              console.log("Step 1: Device is still in hotspot mode. Waiting...");
              return;
            } else if (feederStatus?.mode === "regular") {
              // Hotspot stopped and device is already connected
              console.log("Step 1: Device is no longer in hotspot mode. Progressing to step 2.");
              updateStepStatus(currentStep, "done");
              currentStep++;
              updateStepStatus(currentStep, "in-progress");
              // Continue to check step 2
            } else {
              // Unknown state, keep waiting
              return;
            }
            break;
          case 2:
            // Step 2: Connect to the network
            // We're trying to reach the device on the network
            if (errorStatus === "timeout" || errorStatus === "error") {
              console.log("Step 2: Still can't reach the device. Waiting for connection...");
              return;
            } else if (feederStatus?.mode === "regular") {
              // We can reach the device and it's in regular mode - connection successful!
              console.log("Step 2: Device is reachable in regular mode. Connection successful!");
              updateStepStatus(currentStep, "done");
              currentStep++;
              updateStepStatus(currentStep, "in-progress");
              // Continue to check step 3
            } else if (feederStatus?.mode === "hotspot") {
              // Device went back to hotspot mode - connection failed
              console.log("Step 2: Device is back in hotspot mode. Connection failed.");
              updateStepStatus(currentStep, "error");
              if (feederStatus?.hotspot_status?.connect_state === "wrong_credentials") {
                console.log("Step 2: Wrong credentials detected.");
              }
              return;
            } else {
              return;
            }
            break;
          case 3:
            // Step 3: Connection established
            // Verify the restart process is complete
            if (feederStatus?.mode === "regular" && feederStatus?.hotspot_status?.restart_state === "done") {
              console.log("Step 3: Connection fully established. Restart complete!");
              updateStepStatus(currentStep, "done");
              // Wait a moment to show the success state, then redirect
              setTimeout(function () {
                window.location.replace("http://{{ get_conf("feeder_name") }}.local");
              }, 15000);
              return;
            } else if (feederStatus?.mode === "regular") {
              // Still in regular mode but restart not done yet
              console.log("Step 3: Device connected, waiting for restart to complete...");
              return;
            } else {
              // Something went wrong
              console.log("Step 3: Unexpected state.");
              return;
            }
          default:
            // All steps complete
            return;
        }
      }
    }

    // Start with step 1
    currentStep = 1;
    updateStepStatus(1, "in-progress");

    checkRestartStatus();
    setTimeout(after60, 60 * 1000);
  </script>
{% endblock content %}
