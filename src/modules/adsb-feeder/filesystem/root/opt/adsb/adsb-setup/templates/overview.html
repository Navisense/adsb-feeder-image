{% extends "base-regular.html" %}
{% set active_page = "overview" %}
{% block title %}
  Porttracker SDR Feeder
{% endblock title %}
{% block content %}
  <div class="alert alert-danger {% if get_conf('dns_state') %}d-none{% endif %}"
       role="alert">
    The feeder cannot resolve DNS queries. This will most likely prevent it from working at all.
  </div>
  <div class="alert alert-danger {% if not ipv6_broken %}d-none{% endif %}"
       role="alert">
    The feeder has an IPv6 address but IPv6 isn't working. This can cause docker and other issues.
  </div>
  <div class="alert alert-danger {% if not compose_up_failed %}d-none{% endif %}"
       role="alert">
    docker compose up has failed. This means that something is wrong.
    <form method="post">
      <button type="submit" name="submit" class="btn btn-primary">Retry</button>
    </form>
  </div>
  <div class="alert alert-danger {% if not get_conf('under_voltage') %}d-none{% endif %}"
       role="alert">
    The feeder system kernel detected under-voltage. This can lead to random crashes and various issues with clock
    stability, reduced reception, failing SDRs, etc. Please check and likely replace your power supply.
  </div>
  <div id="ip-mismatch" class="alert alert-info d-none" role="alert">
    The external IP of your browser and the feeder are different. The information in the status links for some of the
    aggregators below may be incorrect.
  </div>
  <div id="low-disk"
       class="alert alert-info {% if not get_conf('low_disk') %}d-none{% endif %}"
       role="alert">
    You are running low on disk space on the your feeder. This can lead to odd problems and even crashes. Consider
    upgrading to a larger storage device.
  </div>
  {% if not aggregators_chosen %}
    <div class="alert alert-info">
      You have not yet chosen which aggregators to share data with. You can do this on the
      <a href="{{ url_for('aggregators') }}">data sharing page</a>.
    </div>
  {% endif %}
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Device info</h5>
      This is <strong>{{ get_conf("site_name") }}</strong>,
      {% if device_hosts %}
        reachable as
        <div class="row">
          {% for device_host in device_hosts %}
            <div class="col-12 col-lg-6 col-xl-4">
              <div id="feeder-reachability-alert-{{ device_host['host'] }}"
                   class="alert alert-primary">
                <a href="http://{{ device_host['host'] }}"
                   id="feeder-reachability-button-{{ device_host['host'] }}"
                   class="btn btn-secondary m-1 disabled"
                   aria-disabled="true"
                   role="button">
                  {{- device_host['host'] -}}
                  {%- if device_host['comment'] %}
                    ({{ device_host["comment"] }})
                  {%- endif -%}
                </a>
                <span id="feeder-reachability-description-{{ device_host['host'] }}"
                      class="small">(checking reachability...)</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        unfortunately, we have no information on how to reach this device.
      {% endif %}
      {% if system_info.external_ip %}
        The external IP (on the public internet) is <strong>{{ system_info.external_ip }}</strong>
        <span id="feeder-external-ip-comment"></span>
      {% else %}
        Unfortunately, we have no information on the device's external IP (on the public internet).
      {% endif %}
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Available SDR devices</h5>
      These SDR devices are connected. You can configure SDR devices on the
      <a href="{{ url_for('sdr_setup') }}">SDR setup page</a>.
      <div id="sdr-devices" class="row my-3"></div>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Data reception</h5>
      <div class="row">
        <div class="col-12 col-lg-6">
          <div id="ais-stats" class="alert">AIS: No information (checking...)</div>
        </div>
        <div class="col-12 col-lg-6">
          <div id="adsb-stats" class="alert">ADS-B: No information (checking...)</div>
        </div>
      </div>
    </div>
    <div id="chart-wrapper" class="m-2 m-lg-5 d-none d-sm-block">
      <canvas id="reception-history-chart"></canvas>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Data sharing</h5>
      You are sharing data with these aggregators. You can add or remove aggregators on the
      <a href="{{ url_for('aggregators') }}">data sharing setup page</a>.
      <div id="aggregators" class="row my-3"></div>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Version</h5>
      <div id="version-info"></div>
    </div>
  </div>
  <script src="{{ url_for('static', filename='js/chart.js') }}"
          integrity="sha256-QvTb/nDEMP/CLHEo82yujVmcrJC4zTfI9CpZ5WXl3rc="
          crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/moment.min.js') }}"
          integrity="sha256-Wz7vWK+PBRpzNQ+1MMzRgm5qIeqECmDVqbgay204I6A="
          crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/chartjs-adapter-moment.js') }}"
          integrity="sha256-p6tY88yPX1/I2nC4PfLYbXO21Y6CV+3eOsWtOdkHt3Y="
          crossorigin="anonymous"></script>
  <script type="text/javascript"
          src="{{ url_for('static', filename='js/netstatus.js') }}"></script>
  <script>
    function appendSdrDevice(sdrDevice) {
      let usageDescription = "unused";
      if (sdrDevice.assignment == "ais") {
        usageDescription = "handling AIS";
      } else if (sdrDevice.assignment == "1090") {
        usageDescription = "handling ADS-B (1090MHz)";
      } else if (sdrDevice.assignment == "978") {
        usageDescription = "handling UAT (978MHz)";
      }
      $("#sdr-devices").append($(`
        <div class="col-12 col-lg-6">
          <div class="card my-2">
            <div class="card-body">
              <h5 class="card-title">Device with serial ${sdrDevice.serial}</h5>
              This is a ${sdrDevice.vendor} ${sdrDevice.product} which is ${usageDescription}.
            </div>
          </div>
        </div>`));
    }

    function createReceptionHistoryChart() {
      let context = document.getElementById("reception-history-chart");
      let chart = new Chart(context, {
        type: 'line',
        data: {
          labels: [],
          datasets: []
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onResize: function(chart, size) {
            const enoughHeight = size.height >= 250;
            const enoughWidth = size.width >= 768;
            chart.options.plugins.legend.display = enoughHeight;
            chart.options.scales.x.ticks.display = enoughHeight;
            chart.options.scales.x.grid.drawOnChartArea = enoughHeight;
            chart.options.scales.pps.ticks.display = enoughWidth;
            chart.options.scales.pps.title.display = enoughWidth;
            chart.options.scales.num.ticks.display = enoughWidth;
            chart.options.scales.num.title.display = enoughWidth;
          },
          plugins: {
            title: {
              display: true,
              text: "Reception statistics",
              font: {
                size: 18,
              }
            },
            legend: {
              onClick: function (e, legendItem) {
                let index = legendItem.datasetIndex;
                if (this.chart.shownIndices.has(index)) {
                  this.chart.shownIndices.delete(index);
                } else {
                  this.chart.shownIndices.add(index);
                }
                if (this.chart.shownIndices.size == this.chart.data.datasets.length) {
                  this.chart.shownIndices.clear();
                }
                updateChartWithShownIndices(this.chart);
              },
              labels: {
                boxWidth: 20,
                useBorderRadius: true,
                borderRadius: 2
              }
            }
          },
          scales: {
            x: {
              type: "time",
              time: {
                tooltipFormat: "YYYY-MM-DD HH:mm:ss",
                minUnit: "second",
                displayFormats: {
                  second: "HH:mm:ss",
                  minute: "HH:mm:ss",
                  hour: "YYYY-MM-DD HH:mm:ss",
                  day: "YYYY-MM-DD",
                  week: "YYYY-MM-DD",
                  month: "YYYY-MM-DD",
                  quarter: "YYYY-MM-DD",
                  year: "YYYY",
                },
              }
            },
            pps: {
              title: {text: "pos/s", display: true},
              type: "linear",
              display: "auto",
              position: "left",
              beginAtZero: true,
            },
            num: {
              title: {text: "number of ships/planes", display: true},
              type: "linear",
              display: "auto",
              position: "right",
              beginAtZero: true,
              grid: {
                drawOnChartArea: false, // Only show grid lines for one axis.
              },
            },
          }
        }
      });
      chart.shownIndices = new Set();
      return chart;
    }

    function updateChartWithShownIndices(chart) {
      // Extend the x axis to the current time.
      chart.options.scales.x.suggestedMax = moment();
      const showAll = chart.shownIndices.size == 0;
      for (let i = 0; i < chart.data.datasets.length; i++) {
        let meta = chart.getDatasetMeta(i);
        meta.hidden = !(showAll || chart.shownIndices.has(i));
      }
      chart.update("none");
    }

    let receptionHistoryChart = createReceptionHistoryChart();

    function updateCurrentStats(stats) {
      updateCurrentCraftStats("AIS", "ships", stats.ais, $(`#ais-stats`));
      updateCurrentCraftStats("ADS-B", "planes", stats.adsb, $(`#adsb-stats`));
    }

    function updateCurrentCraftStats(type, craftName, craftStats, element) {
      element.removeClass("alert-danger alert-success alert-warning");
      if (!craftStats.enabled) {
        element.addClass("alert-warning");
        element.html(`${type} reception is disabled.`);
      } else if (craftStats.current.pps > 0) {
        element.addClass("alert-success");
        element.html(
          `${type}: ${craftStats.current.pps.toFixed(1)} positions per second — `
          + `${craftStats.current.num} ${craftName} visible`);
      } else if (craftStats.uptime < 60) {
        element.addClass("alert-warning");
        element.html(
          `${type} reception has just been enabled, and we've not seen data arriving yet (let's wait a bit...)`);
      } else {
        element.addClass("alert-danger");
        element.html(`${type} reception is enabled, but no data is arriving.`);
      }
    }

    function updateStatsHistory(stats) {
      let light_distinct_colors = [
        "#61c8ff", "#f57200", "#025dfb", "#01d723", "#7300b3", "#a6e927", "#9055ff", "#d8c200",
        "#0039af", "#01db78", "#ff64f8", "#00560b", "#d60098", "#ade587", "#557bff", "#ffaf4c",
        "#6b91ff", "#9d1500", "#3ca4ff", "#574200", "#005296", "#ca0061", "#017960", "#ff8bc4",
        "#1a1a00", "#8ae3ec", "#50003d", "#e4d3b6", "#0f0021", "#ffbbca", "#4f1700", "#008b94"
      ];
      let dark_distinct_colors = [
        "#a94500", "#e1ffe9", "#960089", "#00633e", "#ffce63", "#015d92", "#ff76d4", "#e96200",
        "#ff96ae", "#a7d5ff", "#fdff90", "#bb61ff", "#4c5800", "#283e95", "#bd00e0", "#4fa900",
        "#f8a9ff", "#9dff2f", "#007380", "#4b4539", "#a1003c", "#ffe5cb", "#c00028", "#90af00",
        "#6cf7ff", "#0285fc", "#956900", "#ff1bd4", "#ff8f16", "#ff683c", "#890159", "#00d36d"
      ];
      let distinct_colors = [];
      if (document.documentElement.dataset.mdbTheme == "dark") {
        distinct_colors = dark_distinct_colors;
      } else {
        distinct_colors = light_distinct_colors;
      }
      let datasets = [];
      let colorIdx = 0;
      for (const [type, craftName, craftStats] of [["AIS", "ships", stats.ais], ["ADS-B", "planes", stats.adsb]]) {
        let posRateData = [], numData = [];
        for (const historyItem of craftStats.history) {
          const time = moment.unix(historyItem.ts);
          posRateData.push({x: time, y: historyItem.pps});
          numData.push({x: time, y: historyItem.num});
        }
        datasets.push({
          label: `${type} pos/s`,
          data: posRateData,
          borderColor: distinct_colors[colorIdx++ % distinct_colors.length],
          yAxisID: 'pps',
        });
        datasets.push({
          label: `number of ${craftName}`,
          data: numData,
          borderColor: distinct_colors[colorIdx++ % distinct_colors.length],
          yAxisID: 'num',
        });
      }
      receptionHistoryChart.data.datasets = datasets;
      updateChartWithShownIndices(receptionHistoryChart);
    }

    async function updateConnectivityInfo() {
      let browserIpData = fetch("https://api.ipify.org?format=json", { signal: AbortSignal.timeout(15000) })
        .then(response => response.json());
      const browserIp = (await browserIpData)["ip"];

      // Internal vs. external IP.
      {% if system_info.external_ip %}
        if (browserIp) {
          if ("{{ system_info.external_ip }}" == browserIp) {
            $("#feeder-external-ip-comment").text(" (that's the same as the one of this browser)");
            $("#ip-mismatch").addClass("d-none");
          } else {
            $("#feeder-external-ip-comment").text(
              ` (that's a different one than the one of this browser, which has ${browserIp})`);
            $("#ip-mismatch").removeClass("d-none");
          }
        }
      {% endif %}

      // Reachability of all the device's hosts.
      const connectivityChecker = new FeederConnectivityChecker(
        {{ device_hosts | map(attribute='host') | list | tojson }}, updateReachabilityInfo, 50 * 1000);
      connectivityChecker.start();
    }

    function updateReachabilityInfo(stati, hasTimedOut) {
      for ([host, status] of stati.entries()) {
        let alert = $("#" + $.escapeSelector(`feeder-reachability-alert-${host}`));
        let button = $("#" + $.escapeSelector(`feeder-reachability-button-${host}`));
        let description = $("#" + $.escapeSelector(`feeder-reachability-description-${host}`));
        alert.removeClass("alert-primary alert-success alert-danger");
        button.removeClass("disabled");
        button.removeAttr("aria-disabled");
        if (status == "success") {
          alert.addClass("alert-success");
          description.text("(reachable from this browser)");
        } else if (hasTimedOut) {
          alert.addClass("alert-danger");
          button.addClass("disabled");
          button.attr("aria-disabled", "true");
          description.text("(not reachable, gave up checking)");
        } else {
          alert.addClass("alert-primary");
          button.addClass("disabled");
          button.attr("aria-disabled", "true");
          description.text("(not reachable yet, continuing to check)");
        }
      }
    }

    function appendAggregatorInfo(agg) {
      for (const [type, typeKey] of [["AIS", "ais"], ["ADS-B", "adsb"]]) {
        const status = agg[typeKey];
        if (!status) continue;
        let colorClass = "";
        let dataStatusText = "";
        let mlatStatusHtml = "";
        // Data status.
        if (status.data_status == "good") {
          colorClass = "bg-success";
          dataStatusText = "Data is arriving at the aggregator.";
        } else if (status.data_status == "warning") {
          colorClass = "bg-warning";
          dataStatusText = "Data is arriving at the aggregator, but it doesn't seem to be a lot.";
        } else if (status.data_status == "bad") {
          colorClass = "bg-danger";
          dataStatusText = "No data is arriving at the aggregator.";
        } else if (status.data_status == "starting") {
          colorClass = "bg-info";
          dataStatusText = "We've only just started sending data...";
        } else if (status.data_status == "container_down") {
          colorClass = "bg-danger";
          dataStatusText = "The container sending data is down.";
        } else if (status.data_status == "disconnected") {
          colorClass = "bg-danger";
          dataStatusText = "We're disconnected from the aggregator.";
        } else {
          colorClass = "bg-info";
          dataStatusText = "We have no information whether data is arriving.";
        }
        // MLAT status.
        if (status.mlat_status == "good") {
          mlatStatusHtml = "MLAT is working.";
        } else if (status.mlat_status == "warning") {
          mlatStatusHtml = (
            "There are issues with MLAT (intermittent sync issue / lack of traffic / no other receivers in the area)");
        } else if (status.mlat_status == "bad") {
          mlatStatusHtml = (
            "MLAT is not working (if this persists for hours, check "
            + '<a href="https://github.com/wiedehopf/adsb-wiki/wiki/mlat-check">this page</a>)');
        } else if (status.mlat_status == "disconnected") {
          mlatStatusHtml = "MLAT is not connected.";
        } else if (status.mlat_status == "disabled") {
          mlatStatusHtml = "MLAT is disabled.";
        } else {
          mlatStatusHtml = "We have no information whether MLAT is working.";
        }
        // Append the card.
        $("#aggregators").append(`
          <div class="col-12 col-md-6">
            <div class="card my-2 ${colorClass}" id="${agg.agg_key}-${typeKey}-status">
              <div class="card-header">${type}</div>
              <div class="card-body">
                <h5 class="card-title">${agg.name}</h5>
                ${dataStatusText}
              </div>
              <div class="card-footer"></div>
            </div>
          </div>`);
        if (typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`<br> ${mlatStatusHtml}`);
        }
        // Add a footer with map and status URLs.
        const footer = $(`#${agg.agg_key}-${typeKey}-status > .card-footer`);
        if (agg.map_url) {
          footer.append(`<a href="${agg.map_url}" class="btn btn-secondary m-1" role="button">Aggregator map</a>`);
        } else {
          footer.append(`
            <a class="btn btn-secondary disabled m-1" role="button" aria-disabled="true">No aggregator map</a>`);
        }
        if (agg.status_url) {
          footer.append(
            `<a href="${agg.status_url}" class="btn btn-secondary m-1" role="button">Aggregator status</a>`);
        } else {
          footer.append(`
            <a class="btn btn-secondary disabled m-1" role="button" aria-disabled="true">No aggregator status map</a>`);
        }
        // Some extra info and links for particular aggregators.
        if (agg.agg_key == "adsblol" && typeKey == "adsb") {
          let mlatComment = "(your feeder will be at an approximate location as {{ get_conf('site_name') }})";
          if (agg.adsb.mlat_privacy) {
            mlatComment = "(since you have MLAT privacy enabled, your feeder won't be shown)";
          }
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr">
            <div>
              <a href="https://status.adsb.lol/" class="btn btn-secondary m-1" role="button">ADSB.lol status</a>
              <a href="https://www.adsb.lol/docs/feeders-only/introduction/"
                 class="btn btn-secondary m-1"
                 role="button">ADSB.lol feeder introduction</a>
              <a href="${status.adsblol_link}"
                 class="btn btn-secondary m-1"
                 role="button">personal ADSB.lol URL with the planes you are sending</a>
              <a href="https://mlat.adsb.lol/syncmap/#lat={{ get_conf('lat', default=0) }}#lon={{ get_conf('lon', default=0) }}#zoom=10"
                 class="btn btn-secondary m-1"
                 role="button">ADSB.lol MLAT feeder map for the area around {{ get_conf("site_name") }}</a>
              ${mlatComment}
            </div>`);
        }
        if (agg.agg_key == "flightradar" && typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr">
            <div>
              <a href="{{ url_for('flightaware-status') }}" class="btn btn-secondary m-1" role="button">FR24 status</a>
            </div>`);
        }
        if (agg.agg_key == "flightaware" && typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr">
            <div>
              <a href="{{ url_for('flightaware-status') }}"
                 class="btn btn-secondary m-1"
                 role="button">FlightAware status</a>
            </div>`);
        }
        if (agg.agg_key == "planefinder" && typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr">
            <div>
              <a href="{{ url_for('planefinder-map') }}" class="btn btn-secondary m-1" role="button">Planefinder map</a>
              <a href="{{ url_for('planefinder-status') }}"
                 class="btn btn-secondary m-1"
                 role="button">Planefinder stats</a>
            </div>`);
        }
        if (agg.agg_key == "adsbx" && typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr">
            <div>
              <a href="https://www.adsbexchange.com/api/feeders/?feed=${status.adsbx_feeder_id}"
                 class="btn btn-secondary m-1"
                 role="button">ADSBx Anywhere Stats</a>
              <a href="https://globe.adsbexchange.com/?feed=${status.adsbx_feeder_id}"
                 class="btn btn-secondary m-1"
                 role="button">ADSBx Anywhere Map</a>
            </div>`);
        }
        if (agg.agg_key == "alive" && typeKey == "adsb") {
          $(`#${agg.agg_key}-${typeKey}-status > .card-body`).append(`
            <hr class="hr">
            <div>
              <a href="https://airplanes.live/myfeed/" class="btn btn-secondary m-1" role="button">Status</a>
              <a href="${status.alive_map_link}" class="btn btn-secondary m-1" role="button">Map</a>
            </div>`);
        }
      }
    }

    function updateVersionInfo(versionInfo) {
      $("#version-info").html(`<p>This device is currently running <strong>${versionInfo.version}</strong></p>`);
      if (versionInfo.version == versionInfo.stable_versions[0]) {
        $("#version-info p").append("(this is the latest stable version)");
      } else {
        $("#version-info p").append(`
          (the latest stable version is <strong>${versionInfo.stable_versions[0]}</strong>, see `
          + '<a href="{{ url_for('systemmgmt') }}">system management</a> for update)');
      }
      $("#version-info").append(`
        These Docker containers belong to the application (see <a href="{{ url_for('dozzle') }}">Dozzle</a> for
        details):
        <div id="docker-containers" class="row"></div>`);
      for (const container of versionInfo.containers) {
        let colorClass = "bg-success";
        if (["created", "paused", "exited"].includes(container.state)) {
          colorClass = "bg-info";
        } else if (container.state == "restarting") {
          colorClass = "bg-warning";
        } else if (container.state == "dead" || container.status.includes("unhealthy")) {
          colorClass = "bg-danger";
        }
        $("#docker-containers").append(`
        <div class="col-12 col-md-6">
          <div class="card my-2 ${colorClass}">
            <div class="card-body">
              <h5 class="card-title">${container.name}</h5>
              ${container.status}
            </div>
            <div class="card-footer text-muted">${container.image}</div>
          </div>
        </div>`);
      }
    }

    registerTask(
      "Update SDR devices",
      15000,
      function() {
        $.ajax("/api/sdr_info").done(function (sdrInfo) {
          $("#sdr-devices").html("");
          if (!sdrInfo.sdr_devices || !sdrInfo.sdr_devices.length) {
            $("#sdr-devices").html(makeNotificationCardHtml("info", "No devices", "No SDR devices are connected."));
          } else {
            for (const sdrDevice of sdrInfo.sdr_devices) {
              appendSdrDevice(sdrDevice);
            }
          }
        }).fail(function(jqXHR) {
          $("#sdr-devices").html(makeNotificationCardHtml(
            "error", "Error getting devices", "Error getting info about SDR devices from the feeder."));
        });
      }
    );

    registerTask(
      "Update reception stats",
      15000,
      function() {
        fetch("/api/stats", {signal: AbortSignal.timeout(2000)})
        .then(response => response.json())
        .then(stats => {
          updateCurrentStats(stats);
          updateStatsHistory(stats);
        });
      }
    );

    registerTask(
      "Update aggregator infos",
      60000,
      function() {
        $.ajax("/api/aggregators").done(function (aggregators) {
          $("#aggregators").html("");
          if (!aggregators.length) {
          $("#aggregators").html(makeNotificationCardHtml(
            "info", "No aggregators", "You are not sharing data with any aggregators."));
          } else {
            for (const agg of aggregators) {
              appendAggregatorInfo(agg);
            }
          }
        }).fail(function(jqXHR) {
          $("#aggregators").html(makeNotificationCardHtml(
            "error", "Error getting aggregator info", "Error getting info about aggregators from the feeder."));
        });
      }
    );

    registerTask(
      "Update version info",
      60000,
      function() {
        $.ajax("/api/version-info").done(function (versionInfo) {
          $("#version-info").html("");
          updateVersionInfo(versionInfo);
        }).fail(function(jqXHR) {
          $("#version-info").html(makeNotificationCardHtml(
            "error", "Error getting version info", "Error getting info about software versions from the feeder."));
        });
      }
    );

    registerTask("Update connectivity info", 60000, updateConnectivityInfo);
  </script>
{% endblock content %}
