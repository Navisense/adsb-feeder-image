name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - development
    tags:
      - "*"

permissions:
  contents: write

env:
  VERSION_FILE: "src/modules/adsb-feeder/filesystem/root/opt/adsb/version.txt"
  S3_BUCKET: "s3://navisense-api-files-production/public/device_images"

jobs:
  tag:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      version: ${{ steps.tagging.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and Push Tag
        id: tagging
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(cat $VERSION_FILE)
          echo "Tagging $VERSION"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $VERSION
          git push origin $VERSION

          # Create Release
          gh release create "$VERSION" --generate-notes

  build-install-script:
    runs-on: ubuntu-latest
    needs: [tag]
    steps:
      - uses: actions/checkout@v4

      - name: Generate Install Script
        run: ./.ci/generate-install-script.bash

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-install-script
          path: app-install.bash

      - name: Upload to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.tag.outputs.version }} app-install.bash --clobber

  build-and-upload-image:
    runs-on: ubuntu-latest
    needs: [tag, build-install-script]
    strategy:
      matrix:
        device: [raspberry-pi3, raspberry-pi4, raspberry-pi5]
        variant: [headless, plasma-mobile]
    steps:
      - uses: actions/checkout@v4

      # Setup QEMU for ARM builds via pmbootstrap
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv git openssl zip

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ vars.DEVICE_IMAGE_PUSH_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.DEVICE_IMAGE_PUSH_AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Build and Upload
        run: |
          # The script assumes it can run sudo/root commands.
          # We run the whole script with sudo to ensure pmbootstrap/losetup work.
          # We pass environment variables for AWS to sudo.
          sudo -E ./.ci/build-and-upload-image.bash "${{ needs.tag.outputs.version }}" "${{ matrix.device }}" "${{ matrix.variant }}"
