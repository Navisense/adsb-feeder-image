{% extends "base-regular.html" %}
{% set active_page = "overview" %}
{% block title %}
  Porttracker Feeder Homepage
{% endblock title %}
{% block content %}
  <div class="alert alert-danger {% if get_conf('dns_state') %}d-none{% endif %}"
       role="alert">The feeder cannot resolve DNS queries. This will most likely prevent it from working at all.</div>
  <div class="alert alert-danger {% if not ipv6_broken %}d-none{% endif %}"
       role="alert">
    The feeder has an IPv6 address but IPv6 isn't working. This can cause docker and other issues.
  </div>
  <div class="alert alert-danger {% if not compose_up_failed %}d-none{% endif %}"
       role="alert">
    docker compose up has failed. This means that something is wrong.
    <form method="post">
      <button type="submit" name="submit" value="go" class="btn btn-primary">Retry</button>
    </form>
  </div>
  <div class="alert alert-danger {% if not get_conf('under_voltage') %}d-none{% endif %}"
       role="alert">
    The feeder system kernel detected under-voltage. This can lead to random crashes and various issues with clock
    stability, reduced reception, failing SDRs, etc. Please check and likely replace your power supply.
  </div>
  <div id="ip-mismatch" class="alert alert-info d-none" role="alert">
    The external IP of your browser and the feeder are different. The information in the status links for some of the
    aggregators below may be incorrect.
  </div>
  <div id="low-disk"
       class="alert alert-info {% if not get_conf('low_disk') %}d-none{% endif %}"
       role="alert">
    You are running low on disk space on the your feeder. This can lead to odd problems and even crashes. Consider
    upgrading to a larger storage device.
  </div>
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Device info</h5>
      This is {{ get_conf("site_name") }},
      {% if system_info.network_device_infos or get_conf('mdns.domains') %}
        reachable as
        <ul>
          {% for device_info in system_info.network_device_infos %}
            <li>
              <a href="http://{{ device_info.ip }}">{{ device_info.ip }}</a>
              (device {{ device_info.device }} via {{ device_info.gateway }}):
              <span id="feeder-reachability-{{ device_info.ip }}">checking reachability...</span>
            </li>
          {% endfor %}
          {% for domain in get_conf('mdns.domains') %}
            <li>
              <a href="http://{{ domain }}">{{ domain }}</a>:
              <span id="feeder-reachability-{{ domain }}">checking reachability...</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        unfortunately, we have no information on how to reach this device.
      {% endif %}
      {% if system_info.external_ip %}
        The external IP (on the public internet) is {{ system_info.external_ip }}
        <span id="feeder-external-ip-comment"></span>
      {% else %}
        Unfortunately, we have no information on the device's external IP (on the public internet).
      {% endif %}
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Data reception</h5>
      <div class="row">
        <div class="col-6">
          <div id="ais-stats" class="alert">AIS: No information (checking...)</div>
        </div>
        <div class="col-6">
          <div id="adsb-stats" class="alert">ADS-B: No information (checking...)</div>
        </div>
      </div>
    </div>
    <div id="chart-wrapper" class="m-5 d-none d-md-block"><canvas id="reception-history-chart"></canvas></div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Data sharing</h5>
      <div class="row">
        {% for type, type_key in [('AIS', 'ais'), ('ADS-B', 'adsb')] %}
          {% for agg in enabled_aggregators.values() %}
            {% if not agg.enabled(type_key) %}
              {% continue %}
            {% endif %}
            <div class="col-12 col-md-6">
              <div class="card my-2 bg-info" id="{{ agg.agg_key }}-{{ type_key }}-status">
                <div class="card-header">{{ type }}</div>
                <div class="card-body">
                  <h5 class="card-title">{{ agg.name }}</h5>
                  <span id="{{ agg.agg_key }}-{{ type_key }}-data-status">Checking status...</span>
                  {% if type_key == 'adsb' and get_conf('mlat_enable') %}
                    <span id="{{ agg.agg_key }}-{{ type_key }}-mlat-status"></span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-12 mb-4">
    <div class="small">
      {% if (enabled_aggregators | length) == 0 %}
        No aggregators configured. Add aggregators:
      {% else %}
        Add or remove aggregators:
      {% endif %}
      <a href="{{ url_for('aggregators') }}">Data Sharing</a>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Version</h5>
      <p>
        This device is currently running <strong>{{ get_conf("base_version") }}</strong>
        {% if get_conf("base_version") == tags[0] %}
          (this is the latest stable version)
        {% else %}
          (the latest stable version is <strong>{{ tags[0] }}</strong>, see
          <a href="{{ url_for('systemmgmt') }}">system management</a> for update)
        {% endif %}
      </p>
      These Docker containers belong to the application (see <a href="{{ url_for('/logs/') }}">Dozzle</a> for details):
      <div class="row">
        {% for container in containers %}
          {% with %}
            {% set color_class = 'bg-success' %}
            {% if container.state in ['created', 'paused', 'exited'] %}
              {% set color_class = 'bg-info' %}
            {% elif container.state == 'restarting' %}
              {% set color_class = 'bg-warning' %}
            {% elif container.state == 'dead' or 'unhealthy' in container.status %}
              {% set color_class = 'bg-danger' %}
            {% endif %}
            <div class="col-12 col-md-6">
              <div class="card my-2 {{ color_class }}">
                <div class="card-body">
                  <h5 class="card-title">{{ container.name }}</h5>
                  {{ container.status }}
                </div>
                <div class="card-footer text-muted">{{ container.image }}</div>
              </div>
            </div>
          {% endwith %}
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Available SDR devices</h5>
      {% if sdrs %}
        {{ sdrs | length }} SDR device(s) are connected:
        <div class="row">
          {% for sdr in sdrs %}
            <div class="col-12 col-lg-6 col-xl-4">
              <div class="card my-2">
                <div class="card-body">
                  <h5 class="card-title">Device with serial {{ sdr.serial }}</h5>
                  This is a {{ sdr.vendor }} {{ sdr.product }} which is
                  {% if sdr_assignment(sdr) == 'ais' %}
                    currently handling AIS.
                  {% elif sdr_assignment(sdr) in ['1090', '978'] %}
                    currently handling ADS-B ({{ sdr_assignment(sdr) }}MHz).
                  {% else %}
                    currently unused.
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        There are no SDR devices connected.
      {% endif %}
    </div>
  </div>
  <script src="{{ url_for('static', filename='js/chart.js') }}"
          integrity="sha256-QvTb/nDEMP/CLHEo82yujVmcrJC4zTfI9CpZ5WXl3rc="
          crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/moment.min.js') }}"
          integrity="sha256-Wz7vWK+PBRpzNQ+1MMzRgm5qIeqECmDVqbgay204I6A="
          crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/chartjs-adapter-moment.js') }}"
          integrity="sha256-p6tY88yPX1/I2nC4PfLYbXO21Y6CV+3eOsWtOdkHt3Y="
          crossorigin="anonymous"></script>
  <script type="text/javascript"
          src="{{ url_for('static', filename='js/netstatus.js') }}"></script>
  <script>
  function createReceptionHistoryChart() {
    let context = document.getElementById("reception-history-chart");
    let chart = new Chart(context, {
      type: 'line',
      data: {
        labels: [],
        datasets: []
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: "Reception statistics",
            font: {
              size: 18,
            }
          },
          legend: {
            onClick: function (e, legendItem) {
              let index = legendItem.datasetIndex;
              if (this.chart.shownIndices.has(index)) {
                this.chart.shownIndices.delete(index);
              } else {
                this.chart.shownIndices.add(index);
              }
              if (this.chart.shownIndices.size == this.chart.data.datasets.length) {
                this.chart.shownIndices.clear();
              }
              updateChartWithShownIndices(this.chart);
            },
            labels: {
              boxWidth: 20,
              useBorderRadius: true,
              borderRadius: 2
            }
          }
        },
        scales: {
          x: {
            type: "time",
            time: {
              tooltipFormat: "YYYY-MM-DD HH:mm:ss",
              minUnit: "second",
              displayFormats: {
                second: "HH:mm:ss",
                minute: "HH:mm:ss",
                hour: "YYYY-MM-DD HH:mm:ss",
                day: "YYYY-MM-DD",
                week: "YYYY-MM-DD",
                month: "YYYY-MM-DD",
                quarter: "YYYY-MM-DD",
                year: "YYYY",
              },
            }
          },
          pps: {
            title: {text: "pos/s", display: true},
            type: "linear",
            display: "auto",
            position: "left",
            beginAtZero: true,
          },
          num: {
            title: {text: "number of ships/planes", display: true},
            type: "linear",
            display: "auto",
            position: "right",
            beginAtZero: true,
            grid: {
              drawOnChartArea: false, // Only show grid lines for one axis.
            },
          },
        }
      }
    });
    chart.shownIndices = new Set();
    return chart;
  }

  function updateChartWithShownIndices(chart) {
    // Extend the x axis to the current time.
    chart.options.scales.x.suggestedMax = moment();
    const showAll = chart.shownIndices.size == 0;
    for (let i = 0; i < chart.data.datasets.length; i++) {
      let meta = chart.getDatasetMeta(i);
      meta.hidden = !(showAll || chart.shownIndices.has(i));
    }
    chart.update("none");
  }

  let receptionHistoryChart = createReceptionHistoryChart();

  function updateCurrentStats(stats) {
    updateCurrentCraftStats("AIS", "ships", stats.ais, $(`#ais-stats`));
    updateCurrentCraftStats("ADS-B", "planes", stats.adsb, $(`#adsb-stats`));
  }

  function updateCurrentCraftStats(type, craftName, craftStats, element) {
    element.removeClass("alert-danger alert-success alert-warning");
    if (!craftStats.enabled) {
      element.addClass("alert-warning");
      element.html(`${type} reception is disabled.`);
    } else if (craftStats.current.pps > 0) {
      element.addClass("alert-success");
      element.html(
        `${type}: ${craftStats.current.pps.toFixed(1)} positions per second — `
        + `${craftStats.current.num} ${craftName} visible`);
    } else if (craftStats.uptime < 60) {
      element.addClass("alert-warning");
      element.html(
        `${type} reception has just been enabled, and we've not seen data arriving yet (let's wait a bit...)`);
    } else {
      element.addClass("alert-danger");
      element.html(`${type} reception is enabled, but no data is arriving.`);
    }
  }

  function updateStatsHistory(stats) {
    let light_distinct_colors = [
      "#61c8ff", "#f57200", "#025dfb", "#01d723", "#7300b3", "#a6e927", "#9055ff", "#d8c200",
      "#0039af", "#01db78", "#ff64f8", "#00560b", "#d60098", "#ade587", "#557bff", "#ffaf4c",
      "#6b91ff", "#9d1500", "#3ca4ff", "#574200", "#005296", "#ca0061", "#017960", "#ff8bc4",
      "#1a1a00", "#8ae3ec", "#50003d", "#e4d3b6", "#0f0021", "#ffbbca", "#4f1700", "#008b94"
    ];
    let dark_distinct_colors = [
      "#a94500", "#e1ffe9", "#960089", "#00633e", "#ffce63", "#015d92", "#ff76d4", "#e96200",
      "#ff96ae", "#a7d5ff", "#fdff90", "#bb61ff", "#4c5800", "#283e95", "#bd00e0", "#4fa900",
      "#f8a9ff", "#9dff2f", "#007380", "#4b4539", "#a1003c", "#ffe5cb", "#c00028", "#90af00",
      "#6cf7ff", "#0285fc", "#956900", "#ff1bd4", "#ff8f16", "#ff683c", "#890159", "#00d36d"
    ];
    let distinct_colors = [];
    if (document.documentElement.dataset.mdbTheme == "dark") {
      distinct_colors = dark_distinct_colors;
    } else {
      distinct_colors = light_distinct_colors;
    }
    let datasets = [];
    let colorIdx = 0;
    for (const [type, craftName, craftStats] of [["AIS", "ships", stats.ais], ["ADS-B", "planes", stats.adsb]]) {
      let posRateData = [], numData = [];
      for (const historyItem of craftStats.history) {
        const time = moment.unix(historyItem.ts);
        posRateData.push({x: time, y: historyItem.pps});
        numData.push({x: time, y: historyItem.num});
      }
      datasets.push({
        label: `${type} pos/s`,
        data: posRateData,
        borderColor: distinct_colors[colorIdx++ % distinct_colors.length],
        yAxisID: 'pps',
      });
      datasets.push({
        label: `number of ${craftName}`,
        data: numData,
        borderColor: distinct_colors[colorIdx++ % distinct_colors.length],
        yAxisID: 'num',
      });
    }
    receptionHistoryChart.data.datasets = datasets;
    updateChartWithShownIndices(receptionHistoryChart);
  }

  function refreshAggregatorStatus(aggKey) {
    fetch(`/api/status/${aggKey}`, { signal: AbortSignal.timeout(15000) })
      .then(response => response.json())
      .then(resp => {
        for (const messageType of ["ais", "adsb"]) {
          const status = resp[messageType];
          let dataStatus = "unknown";
          let mlatStatus = null;
          if (status) {
            dataStatus = status.data_status;
            mlatStatus = status.mlat_status;
          }
          let aggCard = $(`#${aggKey}-${messageType}-status`);
          let dataStatusSpan = $(`#${aggKey}-${messageType}-data-status`);
          if (aggCard.length == 0 || dataStatusSpan.length == 0) continue;
          aggCard.removeClass("bg-success bg-warning bg-danger bg-info");
          if (dataStatus == "good") {
            aggCard.addClass("bg-success");
            dataStatusSpan.text("Data is arriving at the aggregator.");
          } else if (dataStatus == "warning") {
            aggCard.addClass("bg-warning");
            dataStatusSpan.text("Data is arriving at the aggregator, but it doesn't seem to be a lot.");
          } else if (dataStatus == "bad") {
            aggCard.addClass("bg-danger");
            dataStatusSpan.text("No data is arriving at the aggregator.");
          } else if (dataStatus == "starting") {
            aggCard.addClass("bg-info");
            dataStatusSpan.text("We've only just started sending data...");
          } else if (dataStatus == "container_down") {
            aggCard.addClass("bg-danger");
            dataStatusSpan.text("The container sending data is down.");
          } else if (dataStatus == "disconnected") {
            aggCard.addClass("bg-danger");
            dataStatusSpan.text("We're disconnected from the aggregator.");
          } else {
            aggCard.addClass("bg-info");
            dataStatusSpan.text("We have no information whether data is arriving.");
          }
          {% if get_conf('mlat_enable') %}
            if (mlatStatus) {
              let mlatStatusSpan = $(`#${aggKey}-${messageType}-mlat-status`);
              if (mlatStatus == "good") {
                mlatStatusSpan.text("MLAT is working.");
              } else if (mlatStatus == "warning") {
                mlatStatusSpan.text(
                  "There are issues with MLAT (intermittent sync issue / lack of traffic / no other receivers in the "
                  + "area)");
              } else if (mlatStatus == "bad") {
                mlatStatusSpan.html(
                  `MLAT is not working (if this persists for hours, check `
                  + `<a href="https://github.com/wiedehopf/adsb-wiki/wiki/mlat-check">this page</a>)`);
              } else if (mlatStatus == "disconnected") {
                mlatStatusSpan.text("MLAT is not connected.");
              } else if (mlatStatus == "disabled") {
                mlatStatusSpan.text("MLAT is disabled.");
              } else {
                mlatStatusSpan.text("We have no information whether MLAT is working.");
              }
            }
          {% endif %}
        }
      });
  }

  async function updateConnectivityInfo() {
    let browserIpData = fetch("https://api.ipify.org?format=json", { signal: AbortSignal.timeout(15000) })
      .then(response => response.json());
    const browserIp = (await browserIpData)["ip"];

    // Internal vs. external IP.
    {% if system_info.external_ip %}
      if (browserIp) {
        if ("{{ system_info.external_ip }}" == browserIp) {
          $("#feeder-external-ip-comment").text(" (that's the same as the one of this browser)");
          $("#ip-mismatch").addClass("d-none");
        } else {
          $("#feeder-external-ip-comment").text(
            ` (that's a different one than the one of this browser, which has ${browserIp})`);
          $("#ip-mismatch").removeClass("d-none");
        }
      }
    {% endif %}

    // Reachability (mDNS and IP).
    const connectivityChecker = new FeederConnectivityChecker(
      {{ device_hosts | tojson }}, updateReachabilityInfo, 50 * 1000, 3000);
    connectivityChecker.start();
  }

  function updateReachabilityInfo(stati, hasTimedOut) {
    for ([host, status] of stati.entries()) {
      let connectivityDescription = document.getElementById(`feeder-reachability-${host}`);
      if (status == "success") {
        connectivityDescription.innerText = "✓";
      } else if (hasTimedOut) {
        connectivityDescription.innerText = `❌ (${status}, gave up checking)`;
      } else {
        connectivityDescription.innerText = `❌ (${status})`;
      }
    }
  }

  registerTask(
    "Update reception stats",
    15000,
    function() {
      fetch("/api/stats", {signal: AbortSignal.timeout(2000)})
      .then(response => response.json())
      .then(stats => {
        updateCurrentStats(stats);
        updateStatsHistory(stats);
      });
    }
  );

  registerTask(
    "Update aggregator status",
    60000,
    function() {
      {% for agg in enabled_aggregators.values() %}
        refreshAggregatorStatus("{{ agg.agg_key }}");
      {% endfor %}
      $("#last-aggregator-status-update").html(new Date().toLocaleTimeString());
    }
  );

  registerTask("Update connectivity info", 60000, updateConnectivityInfo);
  </script>
{% endblock content %}
