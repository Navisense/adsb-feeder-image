{% extends "base-regular.html" %}
{% set active_page = "backup" %}
{% block title %}
  Configuration backup and restore
{% endblock title %}
{% block content %}
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Create a configuration backup</h5>
      You can download a backup of the current feeder configuration here. You can choose which parts of the data you
      want to include below, but note that you have to choose at least one.
      <form action="{{ url_for('download_backup') }}"
            method="get"
            target="_blank">
        <div class="form-outline">
          <div class="form-check">
            <label class="form-check-label">
              <input type="checkbox"
                     class="form-check-input"
                     name="include-config"
                     checked>
              Feeder config
            </label>
            <div class="form-text">
              This is the central configuration of the feeder and not particularly big. It contains all of your
              settings, including passwords for aggregators (so keep this file secure!). If you restore a backup with a
              config, the device you restore it on will behave the same as this one.
            </div>
          </div>
          <div class="form-check">
            <label class="form-check-label">
              <input type="checkbox" class="form-check-input" name="include-stats" checked>
              The feeder's own collected stats
            </label>
            <div class="form-text">
              These are general reception stats generated by the feeder itself. They are used for the graph on the
              overview page. Including this makes the file a little bigger, but not much.
            </div>
          </div>
          <div class="form-check">
            <label class="form-check-label">
              <input type="checkbox" class="form-check-input" name="include-graphs1090">
              Graphs1090 graph data
            </label>
            <div class="form-text">
              This is statistical data written by the ADS-B component used for graphs. It adds a significant amount of
              size to the backup (roughly 15MiB). If you only use AIS, this has no effect.
            </div>
          </div>
          <div class="form-check">
            <label class="form-check-label">
              <input type="checkbox" class="form-check-input" name="include-heatmap">
              Heatmap data
            </label>
            <div class="form-text">
              This is the complete replay/heatmap data of the ADS-B component. If you only use AIS, this has no effect.
              Depending on the amount of historic data you have (if this device has been running a long time), including
              this can take a long time and make the backup much larger. If you want to limit the data retained on disk,
              you can use <code>MAX_GLOBE_HISTORY=365</code> in the environment variables on the
              <a href="{{ url_for('expert') }}">expert page</a> to only retain a year of data.
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Download</button>
      </form>
    </div>
  </div>
  {% if restore_info is not none %}
    <div class="card my-2">
      <div class="card-body">
        <h5 class="card-title">Restore uploaded backup</h5>
        <div class="alert alert-success">A backup file has been uploaded and can be used to restore the config.</div>
        <div class="accordion my-3">
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading-new-files">
              <button class="accordion-button"
                      type="button"
                      data-mdb-toggle="collapse"
                      data-mdb-target="#collapse-new-files"
                      aria-expanded="true"
                      aria-controls="collapse-new-files">New files</button>
            </h2>
            <div id="collapse-new-files"
                 class="accordion-collapse collapse show"
                 aria-labelledby="heading-new-files">
              <div class="accordion-body">
                {% if restore_info["new_files"] %}
                  <div class="alert alert-info">
                    These files are contained in the backup, but not in the config currently in use.
                  </div>
                  <ul class="list-group list-group-light list-group-small">
                    {% for file in restore_info["new_files"] %}
                      <li class="list-group-item">
                        <span class="font-monospace">{{ file["name"] }}</span>
                        ({{ format_binary_prefix(file["size_bytes"]) }}B)
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <div class="alert alert-info">
                    There are no new files in the backup (all of them exist on the current system, though there may be
                    changes.)
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading-changed-files">
              <button class="accordion-button"
                      type="button"
                      data-mdb-toggle="collapse"
                      data-mdb-target="#collapse-changed-files"
                      aria-expanded="false"
                      aria-controls="collapse-changed-files">Changed files</button>
            </h2>
            <div id="collapse-changed-files"
                 class="accordion-collapse collapse show"
                 aria-labelledby="heading-changed-files">
              <div class="accordion-body">
                {% if restore_info["changed_files"] %}
                  <div class="alert alert-info">
                    These files contained in the backup have a corresponding file in the config currently in use, but
                    there are changes.
                  </div>
                  <ul class="list-group list-group-light list-group-small">
                    {% for file in restore_info["changed_files"] %}
                      <li class="list-group-item">
                        <span class="font-monospace">{{ file["name"] }}</span>
                        ({{ format_binary_prefix(file["size_bytes"]) }}B)
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <div class="alert alert-info">There are no files with changes in the backup.</div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading-unchanged-files">
              <button class="accordion-button collapsed"
                      type="button"
                      data-mdb-toggle="collapse"
                      data-mdb-target="#collapse-unchanged-files"
                      aria-expanded="false"
                      aria-controls="collapse-unchanged-files">Unchanged files</button>
            </h2>
            <div id="collapse-unchanged-files"
                 class="accordion-collapse collapse"
                 aria-labelledby="heading-unchanged-files">
              <div class="accordion-body">
                {% if restore_info["unchanged_files"] %}
                  <div class="alert alert-info">
                    These files contained in the backup are the same as their counterparts in the config currently in
                    use.
                  </div>
                  <ul class="list-group list-group-light list-group-small">
                    {% for file in restore_info["unchanged_files"] %}
                      <li class="list-group-item">
                        <span class="font-monospace">{{ file["name"] }}</span>
                        ({{ format_binary_prefix(file["size_bytes"]) }}B)
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <div class="alert alert-info">There are no files without changes in the backup.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% with %}
          {% set disable_restore = false %}
          {% if restore_info["config_status"] == "same_version" %}
            <div class="alert alert-success">
              The backup contains a config of the same config version, which should work fine.
            </div>
          {% elif restore_info["config_status"] == "older_version" %}
            <div class="alert alert-warning">
              The backup contains a config of a previous config version. It will be upgraded to the current version if
              you choose to restore it.
            </div>
          {% elif restore_info["config_status"] == "future_version" %}
            {% set disable_restore = true %}
            <div class="alert alert-danger">
              The backup contains a config of a future config version. Maybe it was generated with a newer version of
              the feeder? In that case, you must upgrade the feeder before restoring this backup. It will not work with
              the current version.
            </div>
          {% elif restore_info["config_status"] == "invalid" %}
            {% set disable_restore = true %}
            <div class="alert alert-danger">
              The backup contains a config, but it is invalid. This backup can't be applied.
            </div>
          {% elif restore_info["config_status"] == "invalid_current" %}
            <div class="alert alert-danger">
              The backup contains a config file. In examining it, the current config was found to be invalid. This
              indicates a serious problem. Maybe applying this backup will fix it.
            </div>
          {% endif %}
          <form method="post" action="{{ url_for('restore') }}">
            <button class="btn btn-primary"
                    type="submit"
                    name="restore-backup"
                    {% if disable_restore %}disabled{% endif %}>Restore this backup</button>
          </form>
        {% endwith %}
      </div>
    </div>
  {% endif %}
  <div class="card my-2">
    <div class="card-body">
      <h5 class="card-title">Upload a backup file</h5>
      {% if restore_info is not none %}
        You can also upload a new backup file here (it will replace the current one).
      {% else %}
        No backup file has been uploaded to restore from. You can upload one here.
      {% endif %}
      The file will be extracted on the device and analyzed. The results will be shown here, and you can choose whether
      you want to restore this backup.
      <form method="post" action="{{ url_for('restore') }}" enctype="multipart/form-data">
        <input class="form-control" type="file" name="file">
        <button class="btn btn-primary mt-3" type="submit" name="upload-file">Upload backup file</button>
      </form>
    </div>
  </div>
{% endblock content %}
